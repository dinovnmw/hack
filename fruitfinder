repeat task.wait() until game:IsLoaded() and game:GetService("Players").LocalPlayer

local Players, ReplicatedStorage, TweenService, HttpService, TeleportService = 
    game:GetService("Players"), 
    game:GetService("ReplicatedStorage"),
    game:GetService("TweenService"),
    game:GetService("HttpService"),
    game:GetService("TeleportService")

local plr = Players.LocalPlayer
local Config = setmetatable({
    AutoFruit = true,
    AutoStoreFruit = true,
    FruitLog = {}
}, {
    __index = _G,
    __newindex = function(t, k, v)
        _G[k] = v
        rawset(t, k, v)
    end
})

-- UI Animation Helper
local function Tween(obj, info, goal)
    return TweenService:Create(obj, TweenInfo.new(unpack(info)), goal):Play()
end

local function JoinTeam()
    if plr.Team ~= game.Teams.Marines and plr.Team ~= game.Teams.Pirates then
        pcall(function()
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_"):InvokeServer("SetTeam", "Marines")
        end)
    end
end

JoinTeam()

local function LoadFruitLog()
    if isfile("fruitlog.json") then
        Config.FruitLog = HttpService:JSONDecode(readfile("fruitlog.json"))
    end
end

local function SaveFruitLog()
    writefile("fruitlog.json", HttpService:JSONEncode(Config.FruitLog))
end

local function LogFruit(fruitName)
    table.insert(Config.FruitLog, {
        fruit = fruitName,
        time = os.date("%H:%M:%S")
    })
    SaveFruitLog()
end

local function FindBasePart(model)
    for _, v in ipairs(model:GetDescendants()) do
        if v:IsA("BasePart") then return v end
    end
end

local function CollectItem(item)
    if not item then return false end
    if item:IsA("Tool") then
        local handle = item:FindFirstChild("Handle")
        if handle then
            handle.CFrame = plr.Character.HumanoidRootPart.CFrame
            task.wait(0.2)
            if not item:IsDescendantOf(workspace) then
                LogFruit(item.Name)
                return true
            end
        end
    elseif item:IsA("Model") and (item.Name:lower():find("fruit")) then
        local basePart = FindBasePart(item)
        if basePart then
            local startTime = tick()
            repeat
                if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    plr.Character.HumanoidRootPart.CFrame = CFrame.new(basePart.Position + Vector3.new(0, 3, 0))
                end
                task.wait()
                if not item:IsDescendantOf(workspace) then
                    LogFruit("Picked Fruit")
                    return true
                end
            until tick() - startTime > 10
        end
    end
    return false
end

local function CreateUI()
    local ui = {}
    local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
    
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -150, 0.5, -150)
    MainFrame.Size = UDim2.new(0, 320, 0, 350)
    MainFrame.ClipsDescendants = true
    
    local Stroke = Instance.new("UIStroke", MainFrame)
    Stroke.Color = Color3.fromRGB(60, 60, 70)
    Stroke.Thickness = 2
    
    local Corner = Instance.new("UICorner", MainFrame)
    Corner.CornerRadius = UDim.new(0, 12)

    -- Top Bar
    local TopBar = Instance.new("Frame", MainFrame)
    TopBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    TopBar.Size = UDim2.new(1, 0, 0, 50)
    TopBar.BorderSizePixel = 0
    
    local Title = Instance.new("TextLabel", TopBar)
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.Size = UDim2.new(1, -30, 1, 0)
    Title.Font = Enum.Font.GothamBold
    Title.Text = "DINOFRUIT"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 18
    Title.TextXAlignment = Enum.TextXAlignment.Left

    -- Glow Effect Animation
    task.spawn(function()
        while task.wait(2) do
            Tween(Stroke, {0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut}, {Color = Color3.fromRGB(100, 100, 255)})
            task.wait(2)
            Tween(Stroke, {0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut}, {Color = Color3.fromRGB(60, 60, 70)})
        end
    end)

    -- Toggle Button
    local ToggleButton = Instance.new("TextButton", MainFrame)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(45, 180, 110)
    ToggleButton.Position = UDim2.new(0, 20, 0, 70)
    ToggleButton.Size = UDim2.new(1, -40, 0, 45)
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.Text = "STATUS: RUNNING"
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.TextSize = 14
    Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

    -- Status Label
    local StatusLabel = Instance.new("TextLabel", MainFrame)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Position = UDim2.new(0, 20, 0, 125)
    StatusLabel.Size = UDim2.new(1, -40, 0, 20)
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.Text = "Initializing..."
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.TextSize = 13
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

    -- Log Container
    local LogFrame = Instance.new("ScrollingFrame", MainFrame)
    LogFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    LogFrame.Position = UDim2.new(0, 20, 0, 155)
    LogFrame.Size = UDim2.new(1, -40, 0, 175)
    LogFrame.BorderSizePixel = 0
    LogFrame.ScrollBarThickness = 2
    LogFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    LogFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Instance.new("UICorner", LogFrame).CornerRadius = UDim.new(0, 8)
    
    local LogList = Instance.new("UIListLayout", LogFrame)
    LogList.Padding = UDim.new(0, 5)
    LogList.SortOrder = Enum.SortOrder.LayoutOrder
    
    Instance.new("UIPadding", LogFrame).PaddingTop = UDim.new(0, 10)

    -- Dragging Logic
    local dragging, dragStart, startPos
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end)

    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    -- Button Click Animation & Logic
    ToggleButton.MouseButton1Click:Connect(function()
        Config.AutoFruit = not Config.AutoFruit
        Config.AutoStoreFruit = Config.AutoFruit
        
        local targetColor = Config.AutoFruit and Color3.fromRGB(45, 180, 110) or Color3.fromRGB(180, 45, 45)
        local targetText = Config.AutoFruit and "STATUS: RUNNING" or "STATUS: STOPPED"
        
        Tween(ToggleButton, {0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out}, {BackgroundColor3 = targetColor})
        ToggleButton.Text = targetText
    end)

    function ui.updateLog()
        for _, child in ipairs(LogFrame:GetChildren()) do
            if child:IsA("TextLabel") then child:Destroy() end
        end
        
        for i = #Config.FruitLog, math.max(1, #Config.FruitLog - 20), -1 do
            local data = Config.FruitLog[i]
            local label = Instance.new("TextLabel", LogFrame)
            label.BackgroundTransparency = 1
            label.Size = UDim2.new(1, -10, 0, 25)
            label.Font = Enum.Font.GothamMedium
            label.TextColor3 = Color3.fromRGB(220, 220, 220)
            label.TextSize = 12
            label.Text = string.format(" [%s] %s", data.time, data.fruit)
            label.TextXAlignment = Enum.TextXAlignment.Left
        end
    end

    ui.updateStatus = function(status)
        StatusLabel.Text = "➤ " .. status
    end

    LoadFruitLog()
    ui.updateLog()
    return ui
end

local function HandleAutoStore(tool)
    if Config.AutoStoreFruit and tool:IsA("Tool") and tool.Name:find("Fruit") then
        task.spawn(function()
            ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", tool:GetAttribute("OriginalName") or tool.Name, tool)
        end)
    end
end

local function StartFruitFinder()
    local ui = CreateUI()
    local lastServerHop = tick()
    local collecting = false
    
    while task.wait() do
        if Config.AutoFruit and not collecting then
            pcall(function()
                local foundFruit = false
                
                for _, v in ipairs(workspace:GetChildren()) do
                    if (v:IsA("Tool") and v.Name:lower():find("fruit")) or (v:IsA("Model") and v.Name:lower():find("fruit")) then
                        foundFruit = true
                        collecting = true
                        ui.updateStatus("Found: " .. v.Name)
                        if CollectItem(v) then
                            ui.updateLog()
                        end
                        collecting = false
                        break
                    end
                end
                
                if not foundFruit and tick() - lastServerHop >= 2 then
                    ui.updateStatus("Searching (Hopping)...")
                    if tick() - lastServerHop >= 5 then
                        ui.updateStatus("Server Hopping...")
                        task.wait(1)
                        local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")).data
                        TeleportService:TeleportToPlaceInstance(game.PlaceId, servers[math.random(1, #servers)].id)
                    end
                end
            end)
        end
    end
end

task.spawn(function()
    while task.wait(1) do
        if Config.AutoStoreFruit then
            for _, fr in ipairs(plr.Backpack:GetChildren()) do HandleAutoStore(fr) end
            if plr.Character then
                for _, fr in ipairs(plr.Character:GetChildren()) do HandleAutoStore(fr) end
            end
        end
    end
end)

StartFruitFinder()
-- // 6. LOGIC CONTROLLERS (THE BRAIN) //

local Logic = {}

function Logic.JoinMarines()
    -- Try to join Marines automatically
    if LocalPlayer.Team and (LocalPlayer.Team.Name ~= "Marines" and LocalPlayer.Team.Name ~= "Pirates") then
        pcall(function()
            Services.ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Marines")
        end)
    end
end

function Logic.StoreFruit(tool)
    if tool:IsA("Tool") and tool.Name:find("Fruit") then
        -- Use pcall to prevent crashes if remote changes
        local s, e = pcall(function()
            Services.ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", tool:GetAttribute("OriginalName"), tool)
        end)
        if s then
            State:Set("Status", "Stored: " .. tool.Name)
        end
    end
end

function Logic.Collect(target)
    if not target then return false end
    
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end

    local collected = false
    local startTime = tick()
    
    -- Logic nhặt đồ thông minh hơn: Teleport -> Wait -> Check
    while tick() - startTime < 8 and target.Parent do -- Max 8s per fruit
        if not State.IsRunning then break end
        
        hrp.CFrame = target.CFrame * CFrame.new(0, 2, 0) -- Teleport slightly above
        
        -- Fire proximity prompt if exists (cho Sea 3 hoặc custom items)
        for _, prompt in ipairs(target:GetDescendants()) do
            if prompt:IsA("ProximityPrompt") then
                fireproximityprompt(prompt)
            end
        end
        
        -- Check if picked up
        if not target:IsDescendantOf(workspace) then
            collected = true
            break
        end
        Services.RunService.Heartbeat:Wait()
    end
    
    return collected
end

function Logic.ServerHop()
    State:Set("Status", "Hopping Server...")
    
    -- Async execution
    task.spawn(function()
        local placeId = game.PlaceId
        local success, servers = pcall(function()
            return Services.HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Asc&limit=100"))
        end)
        
        if success and servers and servers.data then
            -- Find a server that isn't full and isn't the current one
            for _, server in ipairs(servers.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    State:Set("Status", "Joining " .. server.id)
                    Services.TeleportService:TeleportToPlaceInstance(placeId, server.id, LocalPlayer)
                    task.wait(5) -- Wait for teleport
                end
            end
        else
            State:Set("Status", "Hop Failed (API Error)")
            task.wait(2)
        end
    end)
end

function Logic.MainLoop()
    while task.wait(0.5) do
        if State.IsRunning then
            local found = false
            
            -- 1. Scan for Tools (Dropped Fruits)
            for _, v in ipairs(workspace:GetChildren()) do
                if v:IsA("Tool") and v.Name:find("Fruit") and v:FindFirstChild("Handle") then
                    State:Set("Status", "Found: " .. v.Name)
                    if Logic.Collect(v.Handle) then
                        State:AddLog(v.Name)
                        Logic.StoreFruit(v) -- Try to store immediately if in backpack
                    end
                    found = true
                end
            end
            
            -- 2. Scan for Models (Spawned Fruits)
            if not found then
                for _, v in ipairs(workspace:GetChildren()) do
                    if v:IsA("Model") and (v.Name == "Fruit" or v.Name:lower():find("fruit")) then
                        local handle = v:FindFirstChild("Handle") or v:FindFirstChild("Fruit") -- Adjust based on game structure
                        if handle then
                            State:Set("Status", "Found Model: " .. v.Name)
                            if Logic.Collect(handle) then
                                State:AddLog(v.Name)
                            end
                            found = true
                        end
                    end
                end
            end
            
            -- 3. Server Hop if nothing found
            if not found then
                Logic.ServerHop()
                task.wait(5) -- Prevent spamming hop
            end
        else
            State:Set("Status", "Idle")
        end
    end
end

-- Auto Store Loop (Background Task)
task.spawn(function()
    while task.wait(2) do
        if State.IsRunning then
            pcall(function()
                if LocalPlayer.Backpack then
                    for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
                        Logic.StoreFruit(tool)
                    end
                end
                if LocalPlayer.Character then
                    for _, tool in ipairs(LocalPlayer.Character:GetChildren()) do
                        Logic.StoreFruit(tool)
                    end
                end
            end)
        end
    end
end)

-- // 7. INITIALIZATION //
State:LoadLog()
UI.Build()
Logic.JoinMarines()

-- Start Main Loop in protected call
task.spawn(function()
    local s, e = pcall(Logic.MainLoop)
    if not s then warn("Main Loop Crash:", e) end
end)

print("✅ Ultra Fruit Finder Loaded Successfully")
