repeat task.wait() until game:IsLoaded() and game:GetService("Players").LocalPlayer

local Players, ReplicatedStorage, TweenService, HttpService, TeleportService = 
    game:GetService("Players"), 
    game:GetService("ReplicatedStorage"),
    game:GetService("TweenService"),
    game:GetService("HttpService"),
    game:GetService("TeleportService")

local plr = Players.LocalPlayer
local Config = setmetatable({
    AutoFruit = true,
    AutoStoreFruit = true,
    FruitLog = {}
}, {
    __index = _G,
    __newindex = function(t, k, v)
        _G[k] = v
        rawset(t, k, v)
    end
})

-- UI Animation Helper
local function Tween(obj, info, goal)
    return TweenService:Create(obj, TweenInfo.new(unpack(info)), goal):Play()
end

local function JoinTeam()
    if plr.Team ~= game.Teams.Marines and plr.Team ~= game.Teams.Pirates then
        pcall(function()
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_"):InvokeServer("SetTeam", "Marines")
        end)
    end
end

JoinTeam()

local function LoadFruitLog()
    if isfile("fruitlog.json") then
        Config.FruitLog = HttpService:JSONDecode(readfile("fruitlog.json"))
    end
end

local function SaveFruitLog()
    writefile("fruitlog.json", HttpService:JSONEncode(Config.FruitLog))
end

local function LogFruit(fruitName)
    table.insert(Config.FruitLog, {
        fruit = fruitName,
        time = os.date("%H:%M:%S")
    })
    SaveFruitLog()
end

local function FindBasePart(model)
    for _, v in ipairs(model:GetDescendants()) do
        if v:IsA("BasePart") then return v end
    end
end

local function CollectItem(item)
    if not item then return false end
    local hrp = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end

    local targetPart = item:IsA("Tool") and item:FindFirstChild("Handle") or FindBasePart(item)
    
    if targetPart then
        local startTime = tick()
        repeat
            hrp.CFrame = targetPart.CFrame * CFrame.new(0, 1, 0)
            task.wait(0.2)
            if not item:IsDescendantOf(workspace) or item.Parent == plr.Backpack or item.Parent == plr.Character then
                LogFruit(item.Name)
                return true
            end
        until tick() - startTime > 7
    end
    return false
end

local function CreateUI()
    local ui = {}
    local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
    
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -150, 0.5, -150)
    MainFrame.Size = UDim2.new(0, 320, 0, 350)
    MainFrame.ClipsDescendants = true
    
    local Stroke = Instance.new("UIStroke", MainFrame)
    Stroke.Color = Color3.fromRGB(60, 60, 70)
    Stroke.Thickness = 2
    
    local Corner = Instance.new("UICorner", MainFrame)
    Corner.CornerRadius = UDim.new(0, 12)

    local TopBar = Instance.new("Frame", MainFrame)
    TopBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    TopBar.Size = UDim2.new(1, 0, 0, 50)
    TopBar.BorderSizePixel = 0
    
    local Title = Instance.new("TextLabel", TopBar)
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.Size = UDim2.new(1, -30, 1, 0)
    Title.Font = Enum.Font.GothamBold
    Title.Text = "DINOFRUIT - FIXED HOP"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 18
    Title.TextXAlignment = Enum.TextXAlignment.Left

    task.spawn(function()
        while task.wait(2) do
            Tween(Stroke, {0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut}, {Color = Color3.fromRGB(100, 100, 255)})
            task.wait(2)
            Tween(Stroke, {0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut}, {Color = Color3.fromRGB(60, 60, 70)})
        end
    end)

    local ToggleButton = Instance.new("TextButton", MainFrame)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(45, 180, 110)
    ToggleButton.Position = UDim2.new(0, 20, 0, 70)
    ToggleButton.Size = UDim2.new(1, -40, 0, 45)
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.Text = "STATUS: RUNNING"
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.TextSize = 14
    Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

    local StatusLabel = Instance.new("TextLabel", MainFrame)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Position = UDim2.new(0, 20, 0, 125)
    StatusLabel.Size = UDim2.new(1, -40, 0, 20)
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.Text = "Initializing..."
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.TextSize = 13
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

    local LogFrame = Instance.new("ScrollingFrame", MainFrame)
    LogFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    LogFrame.Position = UDim2.new(0, 20, 0, 155)
    LogFrame.Size = UDim2.new(1, -40, 0, 175)
    LogFrame.BorderSizePixel = 0
    LogFrame.ScrollBarThickness = 2
    LogFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    LogFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Instance.new("UICorner", LogFrame).CornerRadius = UDim.new(0, 8)
    
    local LogList = Instance.new("UIListLayout", LogFrame)
    LogList.Padding = UDim.new(0, 5)
    LogList.SortOrder = Enum.SortOrder.LayoutOrder
    Instance.new("UIPadding", LogFrame).PaddingTop = UDim.new(0, 10)

    -- Dragging Logic
    local dragging, dragStart, startPos
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        end
    end)
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)

    ToggleButton.MouseButton1Click:Connect(function()
        Config.AutoFruit = not Config.AutoFruit
        local targetColor = Config.AutoFruit and Color3.fromRGB(45, 180, 110) or Color3.fromRGB(180, 45, 45)
        ToggleButton.Text = Config.AutoFruit and "STATUS: RUNNING" or "STATUS: STOPPED"
        Tween(ToggleButton, {0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out}, {BackgroundColor3 = targetColor})
    end)

    function ui.updateLog()
        for _, child in ipairs(LogFrame:GetChildren()) do if child:IsA("TextLabel") then child:Destroy() end end
        for i = #Config.FruitLog, math.max(1, #Config.FruitLog - 20), -1 do
            local data = Config.FruitLog[i]
            local label = Instance.new("TextLabel", LogFrame)
            label.BackgroundTransparency = 1; label.Size = UDim2.new(1, -10, 0, 25)
            label.Font = Enum.Font.GothamMedium; label.TextColor3 = Color3.fromRGB(220, 220, 220)
            label.TextSize = 12; label.Text = string.format(" [%s] %s", data.time, data.fruit)
            label.TextXAlignment = Enum.TextXAlignment.Left
        end
    end

    ui.updateStatus = function(status) StatusLabel.Text = "➤ " .. status end
    LoadFruitLog(); ui.updateLog()
    return ui
end

local function HandleAutoStore(tool)
    if Config.AutoStoreFruit and tool:IsA("Tool") and tool.Name:find("Fruit") then
        pcall(function()
            ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", tool:GetAttribute("OriginalName") or tool.Name, tool)
        end)
    end
end

local function DoServerHop(ui)
    ui.updateStatus("Server Hopping...")
    task.wait(0.5)
    pcall(function()
        local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")).data
        local randomServer = servers[math.random(1, #servers)]
        TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer.id)
    end)
end

local function StartFruitFinder()
    local ui = CreateUI()
    local lastCheck = tick()
    
    while task.wait() do
        if Config.AutoFruit then
            local foundSomething = false
            for _, v in ipairs(workspace:GetChildren()) do
                local nameLower = string.lower(v.Name)
                if nameLower:find("fruit") then
                    -- Kiểm tra nếu tên chỉ chứa chữ "fruit" (đã xóa khoảng trắng)
                    local cleanName = string.gsub(nameLower, "%s+", "")
                    if cleanName == "fruit" then
                        ui.updateStatus("Only 'Fruit' found. Hopping...")
                        DoServerHop(ui)
                        return
                    end
                    
                    foundSomething = true
                    ui.updateStatus("Picking: " .. v.Name)
                    if CollectItem(v) then
                        ui.updateLog()
                    end
                    break
                end
            end
            
            if not foundSomething and tick() - lastCheck > 3 then
                DoServerHop(ui)
                break
            end
        end
    end
end

task.spawn(function()
    while task.wait(1) do
        if Config.AutoStoreFruit then
            for _, fr in ipairs(plr.Backpack:GetChildren()) do HandleAutoStore(fr) end
            if plr.Character then
                for _, fr in ipairs(plr.Character:GetChildren()) do HandleAutoStore(fr) end
            end
        end
    end
end)

StartFruitFinder()
