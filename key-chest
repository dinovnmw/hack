if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local RbxAnalyticsService = game:GetService("RbxAnalyticsService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local API_URL = "https://dinokey.x10.mx/key.php?api=verify"
local MAIN_URL = "https://raw.githubusercontent.com/dinovnmw/hack/main/PVP"
local CACHE_FILE = "dino_key_cache.json"

local expireTime = nil
local isLifetime = false
local cachedKey = nil

-- ================= UTILS =================
local function createTween(obj, info, goal)
    return TweenService:Create(obj, TweenInfo.new(unpack(info)), goal)
end

-- ================= UI DESIGN =================
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "DinoKeyUI_V2"

local blur = Instance.new("BlurEffect", Lighting)
blur.Size = 0
createTween(blur, {0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out}, {Size = 20}):Play()

local mainFrame = Instance.new("Frame", gui)
mainFrame.Size = UDim2.fromScale(0, 0)
mainFrame.Position = UDim2.fromScale(0.5, 0.5)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
mainFrame.ClipsDescendants = true

local corner = Instance.new("UICorner", mainFrame)
corner.CornerRadius = UDim.new(0, 15)

local stroke = Instance.new("UIStroke", mainFrame)
stroke.Color = Color3.fromRGB(45, 45, 60)
stroke.Thickness = 1.5
stroke.Transparency = 0.5

-- Animation mở Menu
createTween(mainFrame, {0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out}, {Size = UDim2.fromScale(0.3, 0.4)}):Play()

local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0.2, 0)
title.BackgroundTransparency = 1
title.Text = "DINO SYSTEM"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(255, 255, 255)

local status = Instance.new("TextLabel", mainFrame)
status.Size = UDim2.new(1, 0, 0.1, 0)
status.Position = UDim2.new(0, 0, 0.2, 0)
status.BackgroundTransparency = 1
status.Text = "Initializing..."
status.Font = Enum.Font.Gotham
status.TextSize = 13
status.TextColor3 = Color3.fromRGB(150, 150, 170)

local box = Instance.new("TextBox", mainFrame)
box.Size = UDim2.new(0.8, 0, 0.15, 0)
box.Position = UDim2.new(0.1, 0, 0.45, 0)
box.PlaceholderText = "Enter License Key"
box.Font = Enum.Font.Gotham
box.TextSize = 14
box.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
box.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", box).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", box).Color = Color3.fromRGB(50, 50, 70)

local btn = Instance.new("TextButton", mainFrame)
btn.Size = UDim2.new(0.8, 0, 0.15, 0)
btn.Position = UDim2.new(0.1, 0, 0.65, 0)
btn.Text = "VERIFY"
btn.Font = Enum.Font.GothamBold
btn.TextSize = 14
btn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
btn.TextColor3 = Color3.new(1, 1, 1)
btn.AutoButtonColor = false
Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)

-- Hiệu ứng Hover nút
btn.MouseEnter:Connect(function()
    createTween(btn, {0.3}, {BackgroundColor3 = Color3.fromRGB(0, 150, 255)}):Play()
end)
btn.MouseLeave:Connect(function()
    createTween(btn, {0.3}, {BackgroundColor3 = Color3.fromRGB(0, 120, 255)}):Play()
end)

-- ================= LOGIC (GIỮ NGUYÊN) =================
local function getHWID() return RbxAnalyticsService:GetClientId() end

local function verifyKey(key)
    local url = API_URL .. "&key=" .. HttpService:UrlEncode(key) .. "&hwid=" .. HttpService:UrlEncode(getHWID())
    return HttpService:JSONDecode(game:HttpGet(url))
end

local function loadMain()
    createTween(mainFrame, {0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.In}, {Size = UDim2.fromScale(0, 0), BackgroundTransparency = 1}):Play()
    task.wait(0.5)
    gui:Destroy()
    blur:Destroy()
    loadstring(game:HttpGet(MAIN_URL))()
end

btn.MouseButton1Click:Connect(function()
    local key = box.Text:gsub("%s+", "")
    if key == "" then return end

    -- Loading Animation
    btn.Text = "Checking..."
    btn.Active = false
    createTween(btn, {0.2}, {Size = UDim2.new(0.75, 0, 0.15, 0)}):Play()

    local ok, res = pcall(function() return verifyKey(key) end)

    if ok and res.status == "success" then
        status.Text = "Access Granted!"
        status.TextColor3 = Color3.fromRGB(100, 255, 100)
        if writefile then
            writefile(CACHE_FILE, HttpService:JSONEncode({key = key, time = os.time()}))
        end
        loadMain()
    else
        status.Text = "Invalid License Key"
        status.TextColor3 = Color3.fromRGB(255, 100, 100)
        btn.Text = "VERIFY"
        btn.Active = true
        createTween(btn, {0.2, Enum.EasingStyle.Elastic}, {Size = UDim2.new(0.8, 0, 0.15, 0)}):Play()
    end
end)

-- Auto Check Cache
task.spawn(function()
    if isfile and isfile(CACHE_FILE) then
        status.Text = "Checking saved session..."
        local cache = HttpService:JSONDecode(readfile(CACHE_FILE))
        if os.time() - cache.time < 86400 then
            local ok, res = pcall(function() return verifyKey(cache.key) end)
            if ok and res.status == "success" then
                loadMain()
                return
            end
        end
    end
    status.Text = "Welcome back, " .. player.Name
end)
