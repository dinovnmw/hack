--[[
    DinoPVP V2 - Optimized & Fixed
    UI Library: Fluent
    Features: Auto PVP, Aimbot, ESP, Hitbox, Speed, Noclip, Fix Lag
]]

-- ================= LOAD LIBRARY =================
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- ================= SERVICES =================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")

-- ================= VARIABLES =================
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

local Options = Fluent.Options
local Window = Fluent:CreateWindow({
    Title = "DinoPVP V2",
    SubTitle = "Ultimate PVP & Farm",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

-- ================= CONFIGURATION =================
local Config = {
    -- PVP
    AutoAttack = false,
    RetreatHealth = 30,
    EngageHealth = 80,
    RetreatHeight = 100,
    TweenSpeed = 250, -- Studs per second
    
    -- Combat
    FastAttack = false,
    Aimbot = false,
    AimbotFOV = 150,
    AimbotSmooth = 0.5,
    Hitbox = false,
    HitboxSize = 5,
    ESP = false,
    
    -- Movement
    WalkSpeed = 16,
    JumpPower = 50,
    Noclip = false,
    WalkWater = false,
    WaterHeight = -1
}

local State = {
    IsRetreating = false,
    Target = nil
}

-- ================= TABS =================
local Tabs = {
    PVP = Window:AddTab({ Title = "PVP Bot", Icon = "swords" }),
    Combat = Window:AddTab({ Title = "Combat", Icon = "crosshair" }),
    Player = Window:AddTab({ Title = "Player", Icon = "user" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "settings" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "save" })
}

-- ================= UTILITIES =================

-- Find nearest enemy ignoring team mates
local function GetNearestEnemy(maxDistance)
    local closestPlayer = nil
    local shortestDistance = maxDistance or math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            -- Check if alive and not on same team
            if humanoid and humanoid.Health > 0 then
                if not player.Team or player.Team ~= LocalPlayer.Team then
                    local dist = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                    if dist < shortestDistance then
                        closestPlayer = player
                        shortestDistance = dist
                    end
                end
            end
        end
    end
    return closestPlayer
end

-- Smooth movement using TweenService
local function TweenTo(cframe)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    local hrp = char.HumanoidRootPart
    local distance = (hrp.Position - cframe.Position).Magnitude
    local speed = Config.TweenSpeed
    local time = distance / speed
    
    local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = cframe})
    tween:Play()
end

-- Simulate Mouse Click
local function Click()
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
end

-- Fix Lag Function
local function FixLag()
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    Lighting.Brightness = 0
    settings().Rendering.QualityLevel = "Level01"
    
    for _, v in pairs(Workspace:GetDescendants()) do
        if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("CornerWedgePart") or v:IsA("TrussPart") then
            v.Material = "Plastic"
            v.Reflectance = 0
        elseif v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Lifetime = NumberRange.new(0)
        elseif v:IsA("Explosion") then
            v.BlastPressure = 1
            v.BlastRadius = 1
        end
    end
    
    Fluent:Notify({
        Title = "Fix Lag",
        Content = "Graphics reduced for better FPS.",
        Duration = 3
    })
end

-- ================= UI ELEMENTS =================

-- [[ PVP TAB ]]
local PVPSection = Tabs.PVP:AddSection("Auto PVP Logic")

PVPSection:AddToggle("AutoPVP", {
    Title = "Enable Auto PVP Bot",
    Default = false,
    Callback = function(Value)
        Config.AutoAttack = Value
    end
})

PVPSection:AddSlider("RetreatHP", {
    Title = "Retreat Health %",
    Min = 10, Max = 90, Default = 30, Rounding = 0,
    Callback = function(Value) Config.RetreatHealth = Value end
})

PVPSection:AddSlider("EngageHP", {
    Title = "Re-Engage Health %",
    Min = 20, Max = 100, Default = 80, Rounding = 0,
    Callback = function(Value) Config.EngageHealth = Value end
})

PVPSection:AddSlider("TweenSpd", {
    Title = "Movement Speed (Tween)",
    Min = 50, Max = 500, Default = 250, Rounding = 0,
    Callback = function(Value) Config.TweenSpeed = Value end
})

-- [[ COMBAT TAB ]]
local CombatSection = Tabs.Combat:AddSection("Assists")

CombatSection:AddToggle("FastAttack", {
    Title = "Fast Attack (Auto Click)",
    Default = false,
    Callback = function(Value) Config.FastAttack = Value end
})

CombatSection:AddToggle("Aimbot", {
    Title = "Camera Aimbot",
    Default = false,
    Callback = function(Value) Config.Aimbot = Value end
})

CombatSection:AddSlider("AimbotFOV", {
    Title = "Aimbot FOV",
    Min = 50, Max = 800, Default = 150, Rounding = 0,
    Callback = function(Value) Config.AimbotFOV = Value end
})

CombatSection:AddToggle("ESP", {
    Title = "Player ESP (Chams)",
    Default = false,
    Callback = function(Value) Config.ESP = Value end
})

CombatSection:AddToggle("Hitbox", {
    Title = "Hitbox Expander",
    Default = false,
    Callback = function(Value) Config.Hitbox = Value end
})

CombatSection:AddSlider("HitboxSiz", {
    Title = "Hitbox Size",
    Min = 2, Max = 20, Default = 5, Rounding = 0,
    Callback = function(Value) Config.HitboxSize = Value end
})

-- [[ PLAYER TAB ]]
local PlayerSection = Tabs.Player:AddSection("Local Player")

PlayerSection:AddSlider("WalkSpeed", {
    Title = "Walk Speed",
    Min = 16, Max = 200, Default = 16, Rounding = 0,
    Callback = function(Value) 
        Config.WalkSpeed = Value 
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = Value
        end
    end
})

PlayerSection:AddSlider("JumpPower", {
    Title = "Jump Power",
    Min = 50, Max = 300, Default = 50, Rounding = 0,
    Callback = function(Value) 
        Config.JumpPower = Value 
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = Value
        end
    end
})

PlayerSection:AddToggle("Noclip", {
    Title = "Noclip (Walk Through Walls)",
    Default = false,
    Callback = function(Value) Config.Noclip = Value end
})

PlayerSection:AddToggle("WalkWater", {
    Title = "Walk On Water",
    Default = false,
    Callback = function(Value) Config.WalkWater = Value end
})

-- [[ MISC TAB ]]
Tabs.Misc:AddButton({
    Title = "FPS Boost / Fix Lag",
    Description = "Removes textures and shadows",
    Callback = FixLag
})

-- ================= LOGIC LOOPS =================

-- 1. PVP BOT LOOP
task.spawn(function()
    while task.wait(0.1) do
        if not Config.AutoAttack then continue end
        
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("Humanoid") or not char:FindFirstChild("HumanoidRootPart") then continue end
        
        local hum = char.Humanoid
        local hrp = char.HumanoidRootPart
        local healthPct = (hum.Health / hum.MaxHealth) * 100

        -- Health Check Logic
        if healthPct <= Config.RetreatHealth then
            State.IsRetreating = true
        elseif healthPct >= Config.EngageHealth then
            State.IsRetreating = false
        end

        if State.IsRetreating then
            -- Fly Up
            TweenTo(CFrame.new(hrp.Position.X, hrp.Position.Y + 50, hrp.Position.Z))
        else
            -- Attack Logic
            local target = GetNearestEnemy(1000)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                local targetPos = target.Character.HumanoidRootPart.CFrame
                
                -- Move slightly behind/near target
                TweenTo(targetPos * CFrame.new(0, 0, 3))
                
                -- Look at target
                hrp.CFrame = CFrame.lookAt(hrp.Position, target.Character.HumanoidRootPart.Position)
                
                -- Click if close
                if (hrp.Position - target.Character.HumanoidRootPart.Position).Magnitude < 15 then
                    Click()
                end
            end
        end
    end
end)

-- 2. FAST ATTACK LOOP
task.spawn(function()
    while task.wait() do
        if Config.FastAttack then
            Click()
        end
    end
end)

-- 3. RENDER STEPPED (Aimbot, ESP, Hitbox)
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Filled = false

RunService.RenderStepped:Connect(function()
    -- Update FOV Circle
    FOVCircle.Visible = Config.Aimbot
    FOVCircle.Radius = Config.AimbotFOV
    FOVCircle.Position = Vector2.new(Mouse.X, Mouse.Y + 36) -- Offset for topbar

    -- Aimbot Logic
    if Config.Aimbot then
        local target = GetNearestEnemy(Config.AimbotFOV) -- Logic needs screen check ideally, but distance works for basic
        if target and target.Character and target.Character:FindFirstChild("Head") then
            local targetPos = target.Character.Head.Position
            local currentCF = Camera.CFrame
            local targetCF = CFrame.new(currentCF.Position, targetPos)
            
            Camera.CFrame = currentCF:Lerp(targetCF, Config.AimbotSmooth)
        end
    end

    -- Hitbox & ESP Loop
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local hum = plr.Character:FindFirstChild("Humanoid")
            
            -- Hitbox Logic
            if Config.Hitbox and plr.Team ~= LocalPlayer.Team then
                hrp.Size = Vector3.new(Config.HitboxSize, Config.HitboxSize, Config.HitboxSize)
                hrp.Transparency = 0.7
                hrp.CanCollide = false
            else
                -- Reset size if disabled (Approximation)
                hrp.Size = Vector3.new(2, 2, 1)
                hrp.Transparency = 1
            end

            -- ESP Logic
            local highlight = plr.Character:FindFirstChild("DinoESP")
            if Config.ESP and plr.Team ~= LocalPlayer.Team and hum and hum.Health > 0 then
                if not highlight then
                    highlight = Instance.new("Highlight")
                    highlight.Name = "DinoESP"
                    highlight.FillColor = Color3.fromRGB(255, 0, 0)
                    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                    highlight.FillTransparency = 0.5
                    highlight.Parent = plr.Character
                end
            else
                if highlight then highlight:Destroy() end
            end
        end
    end
end)

-- 4. PHYSICS STEPPED (Noclip, WalkSpeed, Water)
RunService.Stepped:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    
    -- Noclip
    if Config.Noclip then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then
                part.CanCollide = false
            end
        end
    end

    -- WalkSpeed & JumpPower Enforcement
    local hum = char:FindFirstChild("Humanoid")
    if hum then
        if hum.WalkSpeed ~= Config.WalkSpeed then hum.WalkSpeed = Config.WalkSpeed end
        if hum.JumpPower ~= Config.JumpPower then hum.JumpPower = Config.JumpPower end
    end

    -- Walk On Water
    if Config.WalkWater then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            local rayOrigin = hrp.Position
            local rayDirection = Vector3.new(0, -10, 0)
            local raycastParams = RaycastParams.new()
            raycastParams.FilterDescendantsInstances = {char}
            raycastParams.FilterType = Enum.RaycastFilterType.Exclude
            
            local ray = Workspace:Raycast(rayOrigin, rayDirection, raycastParams)
            if ray and ray.Material == Enum.Material.Water then
                -- Keep player above water
                local currentVel = hrp.Velocity
                hrp.Velocity = Vector3.new(currentVel.X, 0, currentVel.Z)
                hrp.Position = Vector3.new(hrp.Position.X, ray.Position.Y + 3.5, hrp.Position.Z)
            end
        end
    end
end)

-- ================= FINALIZE =================
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetFolder("DinoPVP")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "DinoPVP V2 Loaded",
    Content = "Script optimized and ready!",
    Duration = 5
})
