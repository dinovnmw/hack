-- ================= LOAD FLUENT =================
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- ================= SERVICES =================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- ================= CONFIG =================
local Config = {
    AutoAttack = false,
    RetreatHealth = 30,
    EngageHealth = 80,
    RetreatHeight = 400,
    ClickSpeed = 0.1,
    TweenSpeed = 250,

    Noclip = false,
    WalkWater = false,
    SafeWaterHeight = -1.5,

    ESP_Enabled = false,

    AimbotEnabled = false,
    AimbotSmoothness = 0.1,
    AimbotFOV = 150,

    HitboxEnabled = false,
    HitboxSize = 6
}

local State = {
    IsRetreating = false
}

-- ================= WINDOW =================
local Window = Fluent:CreateWindow({
    Title = "DinoPVP",
    SubTitle = "Fluent UI Fixed",
    TabWidth = 160,
    Size = UDim2.fromOffset(600, 480),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    PVP = Window:AddTab({ Title = "PVP Bot", Icon = "swords" }),
    Combat = Window:AddTab({ Title = "Aimbot ESP", Icon = "crosshair" }),
    Move = Window:AddTab({ Title = "Movement", Icon = "move" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- ================= UTILS =================
local function GetNearestEnemy(maxDist)
    local closest, dist = nil, maxDist or math.huge
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if plr.Character.Humanoid.Health > 0 then
                if not LocalPlayer.Team or plr.Team ~= LocalPlayer.Team then
                    local d = (LocalPlayer.Character.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                    if d < dist then
                        dist = d
                        closest = plr
                    end
                end
            end
        end
    end
    return closest
end

local function TweenTo(cf)
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local dist = (hrp.Position - cf.Position).Magnitude
    local time = dist / Config.TweenSpeed

    TweenService:Create(
        hrp,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        { CFrame = cf }
    ):Play()

    for _, p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            p.CanCollide = false
        end
    end
end

local function AutoClick()
    local vp = Camera.ViewportSize
    VirtualInputManager:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, true, game, 1)
    task.wait(Config.ClickSpeed)
    VirtualInputManager:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, false, game, 1)
end

-- ================= NOCLIP =================
RunService.Stepped:Connect(function()
    if Config.Noclip and LocalPlayer.Character then
        for _, p in ipairs(LocalPlayer.Character:GetDescendants()) do
            if p:IsA("BasePart") then
                p.CanCollide = false
            end
        end
    end
end)

-- ================= WALK WATER =================
RunService.Stepped:Connect(function()
    if not Config.WalkWater then return end
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local ray = Workspace:Raycast(hrp.Position, Vector3.new(0, -6, 0))
    if ray and ray.Material == Enum.Material.Water then
        hrp.Velocity = Vector3.new(hrp.Velocity.X, 0, hrp.Velocity.Z)
        hrp.Position = Vector3.new(hrp.Position.X, ray.Position.Y + Config.SafeWaterHeight, hrp.Position.Z)
    end
end)

-- ================= HITBOX =================
RunService.RenderStepped:Connect(function()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local hb = hrp:FindFirstChild("HitboxExtender")

            if Config.HitboxEnabled then
                if not hb then
                    hb = Instance.new("Part")
                    hb.Name = "HitboxExtender"
                    hb.CanCollide = false
                    hb.Anchored = false
                    hb.Transparency = 0.7
                    hb.Color = Color3.fromRGB(255,255,0)
                    hb.Parent = hrp
                end
                hb.Size = Vector3.new(Config.HitboxSize, Config.HitboxSize, Config.HitboxSize)
                hb.CFrame = hrp.CFrame
            elseif hb then
                hb:Destroy()
            end
        end
    end
end)

-- ================= ESP =================
RunService.RenderStepped:Connect(function()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hl = plr.Character:FindFirstChild("ESP")
            if Config.ESP_Enabled then
                if not hl then
                    hl = Instance.new("Highlight")
                    hl.Name = "ESP"
                    hl.FillColor = Color3.fromRGB(255,0,0)
                    hl.FillTransparency = 0.5
                    hl.Parent = plr.Character
                end
            elseif hl then
                hl:Destroy()
            end
        end
    end
end)

-- ================= AIMBOT =================
local FOV = Drawing.new("Circle")
FOV.Thickness = 1

RunService.RenderStepped:Connect(function()
    if Config.AimbotEnabled and not Config.AutoAttack then
        local target = GetNearestEnemy(Config.AimbotFOV)
        FOV.Visible = true
        FOV.Radius = Config.AimbotFOV
        FOV.Position = Vector2.new(Mouse.X, Mouse.Y + 36)

        if target and target.Character and target.Character:FindFirstChild("Head") then
            TweenService:Create(
                Camera,
                TweenInfo.new(Config.AimbotSmoothness),
                { CFrame = CFrame.new(Camera.CFrame.Position, target.Character.Head.Position) }
            ):Play()
        end
    else
        FOV.Visible = false
    end
end)

-- ================= AUTO PVP =================
task.spawn(function()
    while task.wait() do
        if Config.AutoAttack and LocalPlayer.Character then
            local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
            local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if not hum or not hrp then continue end

            local hp = hum.Health / hum.MaxHealth * 100
            if hp <= Config.RetreatHealth then
                State.IsRetreating = true
            elseif hp >= Config.EngageHealth then
                State.IsRetreating = false
            end

            if State.IsRetreating then
                TweenTo(CFrame.new(hrp.Position.X, Config.RetreatHeight, hrp.Position.Z))
            else
                local target = GetNearestEnemy()
                if target and target.Character then
                    TweenTo(target.Character.HumanoidRootPart.CFrame * CFrame.new(0,0,3))
                    if (hrp.Position - target.Character.HumanoidRootPart.Position).Magnitude < 15 then
                        AutoClick()
                    end
                end
            end
        end
    end
end)

-- ================= UI =================
Tabs.PVP:AddToggle("AutoPVP", {
    Title = "Auto PVP Bot",
    Default = false,
    Callback = function(v)
        Config.AutoAttack = v
        if v then Config.AimbotEnabled = false end
    end
})

Tabs.PVP:AddSlider("RetreatHP", {
    Title = "Rút lui khi máu %",
    Min = 10,
    Max = 50,
    Default = 30,
    Rounding = 0,
    Callback = function(v) Config.RetreatHealth = v end
})

Tabs.PVP:AddSlider("EngageHP", {
    Title = "Quay lại khi máu %",
    Min = 50,
    Max = 100,
    Default = 80,
    Rounding = 0,
    Callback = function(v) Config.EngageHealth = v end
})

Tabs.Combat:AddToggle("Aimbot", {
    Title = "Aimbot",
    Default = false,
    Callback = function(v)
        Config.AimbotEnabled = v
        if v then Config.AutoAttack = false end
    end
})

Tabs.Combat:AddSlider("FOV", {
    Title = "FOV",
    Min = 50,
    Max = 500,
    Default = 150,
    Rounding = 0,
    Callback = function(v) Config.AimbotFOV = v end
})

Tabs.Combat:AddSlider("Smooth", {
    Title = "Aimbot Smooth",
    Min = 0.05,
    Max = 1,
    Default = 0.1,
    Rounding = 2,
    Callback = function(v) Config.AimbotSmoothness = v end
})

Tabs.Combat:AddToggle("ESP", {
    Title = "ESP Player",
    Default = false,
    Callback = function(v) Config.ESP_Enabled = v end
})

Tabs.Combat:AddToggle("Hitbox", {
    Title = "Hitbox Extender",
    Default = false,
    Callback = function(v) Config.HitboxEnabled = v end
})

Tabs.Combat:AddSlider("HitboxSize", {
    Title = "Hitbox Size",
    Min = 3,
    Max = 15,
    Default = 6,
    Rounding = 0,
    Callback = function(v) Config.HitboxSize = v end
})

Tabs.Move:AddToggle("Noclip", {
    Title = "Noclip",
    Default = false,
    Callback = function(v) Config.Noclip = v end
})

Tabs.Move:AddToggle("WalkWater", {
    Title = "Walk On Water",
    Default = false,
    Callback = function(v) Config.WalkWater = v end
})

Tabs.Settings:AddSlider("TweenSpeed", {
    Title = "Tween Speed",
    Min = 100,
    Max = 500,
    Default = 250,
    Rounding = 0,
    Callback = function(v) Config.TweenSpeed = v end
})

-- ================= SAVE =================
SaveManager:SetLibrary(Fluent)
SaveManager:SetFolder("DinoPVP")
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:SetFolder("DinoPVP")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)

