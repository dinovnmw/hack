-- [LAYER 1] SERVICE INITIALIZATION & ABSTRACTION
local Services = {
    Players = game:GetService("Players"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    UserInputService = game:GetService("UserInputService"),
    VirtualInputManager = game:GetService("VirtualInputManager"),
    Lighting = game:GetService("Lighting"),
    HttpService = game:GetService("HttpService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage")
}
-- Load Fluent UI library with error protection
local Success, Fluent = pcall(function()
    return loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
end)
if not Success or not Fluent then
    warn("[CRITICAL ERROR]: Failed to load Fluent library. Check your internet connection.")
    return
end
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()
-- [LAYER 1] GLOBAL VARIABLES & TYPE DEFINITIONS
local LocalPlayer = Services.Players.LocalPlayer
local CurrentCamera = Services.Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
type Config = {
    -- Aimbot
    EnableAimbot: boolean,
    AimPart: string,
    Smoothness: number,
    RotateCharacterToTarget: boolean,
    WallCheck: boolean,
    TeamCheck: boolean,
    TargetMode: string, -- "Distance" or "Health"
    AimCursor: boolean,
    -- Combat
    EnableKillAura: boolean,
    AuraRange: number,
    TriggerBot: boolean,
    ExpandHitbox: boolean,
    HitboxSize: number,
    HitboxTransparency: number,
    Reach: number,
    -- Visuals/ESP
    EnableESP: boolean,
    ShowBox: boolean,
    ShowTracer: boolean,
    ShowName: boolean,
    ShowHealthBar: boolean,
    EnableHighlight: boolean,
    HighlightFillColor: Color3,
    HighlightFillTransparency: number,
    HighlightOutlineColor: Color3,
    HighlightOutlineTransparency: number,
    -- Movement
    WalkSpeed: number,
    JumpPower: number,
    Fly: boolean,
    FlySpeed: number,
    Noclip: boolean,
    InfiniteJump: boolean,
    -- Teleport
    EnableTeleport: boolean,
    TeleportTarget: string,
    TeleportLoop: boolean,
    TeleportSpeed: number,
    -- Safety
    EnableSafety: boolean,
    SafetyHealth: number,
    EscapeDistance: number,
    -- Legit
    EnableLegitAimbot: boolean,
    LegitSmoothness: number,
    EnableLegitTween: boolean,
    LegitTweenSpeed: number,
    -- Misc
    FPSBoost: boolean,
    Fullbright: boolean,
    AntiKick: boolean,
    AntiAFK: boolean,
    -- New PVP Functions
    AutoParry: boolean,
    InfiniteCombo: boolean,
    NoStun: boolean,
    AntiLock: boolean,
    AutoDodge: boolean,
    FastAttack: boolean,
    NoCooldown: boolean,
    DamageMultiplier: number,
    HealthRegen: boolean,
    AutoEatFruit: boolean,
    GodMode: boolean,
    InfiniteStamina: boolean,
    AutoUseSkills: boolean,
    KillAll: boolean,
    NoFallDamage: boolean
}
local Config: Config = {
    EnableAimbot = false,
    AimPart = "Head",
    Smoothness = 0.1,
    RotateCharacterToTarget = true,
    WallCheck = false,
    TeamCheck = true,
    TargetMode = "Distance",
    AimCursor = false,
    EnableKillAura = false,
    AuraRange = 20,
    TriggerBot = false,
    ExpandHitbox = false,
    HitboxSize = 10,
    HitboxTransparency = 0.7,
    Reach = 15,
    EnableESP = false,
    ShowBox = false,
    ShowTracer = false,
    ShowName = false,
    ShowHealthBar = false,
    EnableHighlight = false,
    HighlightFillColor = Color3.fromRGB(255, 0, 0),
    HighlightFillTransparency = 0.5,
    HighlightOutlineColor = Color3.fromRGB(255, 255, 255),
    HighlightOutlineTransparency = 0,
    WalkSpeed = 16,
    JumpPower = 50,
    Fly = false,
    FlySpeed = 50,
    Noclip = false,
    InfiniteJump = false,
    EnableTeleport = false,
    TeleportTarget = "",
    TeleportLoop = false,
    TeleportSpeed = 100,
    EnableSafety = false,
    SafetyHealth = 30,
    EscapeDistance = 1000,
    EnableLegitAimbot = false,
    LegitSmoothness = 0.5,
    EnableLegitTween = false,
    LegitTweenSpeed = 50,
    FPSBoost = false,
    Fullbright = true,
    AntiKick = true,
    AntiAFK = true,
    -- New
    AutoParry = false,
    InfiniteCombo = false,
    NoStun = false,
    AntiLock = false,
    AutoDodge = false,
    FastAttack = false,
    NoCooldown = false,
    DamageMultiplier = 1,
    HealthRegen = false,
    AutoEatFruit = false,
    GodMode = false,
    InfiniteStamina = false,
    AutoUseSkills = false,
    KillAll = false,
    NoFallDamage = false
}
-- [LAYER 2] DRAWING API & CACHE MANAGEMENT
local ESPStorage = {}
local function CreateDrawing(type: string, props: table)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do
        obj[k] = v
    end
    return obj
end
-- [LAYER 3] TARGET VALIDATION & LOGIC
local function IsValidTarget(player: Player): boolean
    if not player or player == LocalPlayer or not player.Character then return false end
   
    local char = player.Character
    local humanoid = char:FindFirstChild("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    local head = char:FindFirstChild("Head")
   
    if not humanoid or not root or not head or humanoid.Health <= 0 then return false end
    if char:FindFirstChild("ForceField") then return false end
    if Config.TeamCheck and player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then return false end
   
    return true
end
local function CanSeeTarget(targetPart: BasePart): boolean
    if not Config.WallCheck then return true end
   
    local origin = CurrentCamera.CFrame.Position
    local direction = targetPart.Position - origin
   
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, CurrentCamera}
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.IgnoreWater = true
   
    local result = Services.Workspace:Raycast(origin, direction, params)
   
    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    return true
end
local function GetNearestPlayer()
    local bestTarget = nil
    local bestDist = math.huge
   
    for _, player in ipairs(Services.Players:GetPlayers()) do
        if IsValidTarget(player) then
            local char = player.Character
            local root = char:FindFirstChild("HumanoidRootPart")
            if root then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - root.Position).Magnitude
                if dist < bestDist and CanSeeTarget(root) then
                    bestDist = dist
                    bestTarget = player
                end
            end
        end
    end
   
    return bestTarget
end
local function Fire()
    Services.VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
    task.wait(0.005)
    Services.VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
end
local function TweenToPosition(targetPos: Vector3, speed: number)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    local root = char.HumanoidRootPart
    local distance = (root.Position - targetPos).Magnitude
    local duration = distance / speed
    
    -- Dừng các Tween cũ nếu đang chạy để tránh giật lag
    if _G.CurrentTeleportTween then
        _G.CurrentTeleportTween:Cancel()
    end

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    _G.CurrentTeleportTween = Services.TweenService:Create(root, tweenInfo, {CFrame = CFrame.new(targetPos)})
    _G.CurrentTeleportTween:Play()
    
    return _G.CurrentTeleportTween
end
-- New Functions Logic
local function AutoParryLogic()
    -- Simulate auto parry by detecting attacks and blocking
    -- Placeholder: Actual implementation depends on game mechanics
end
local function InfiniteComboLogic()
    -- Allow infinite attacks without break
end
local function NoStunLogic()
    -- Prevent stun effects
end
local function AntiLockLogic()
    -- Anti aim lock
end
local function AutoDodgeLogic()
    -- Auto dodge incoming attacks
end
local function FastAttackLogic()
    -- Increase attack speed
end
local function NoCooldownLogic()
    -- Remove skill cooldowns
end
local function DamageMultiplierLogic()
    -- Multiply damage output
end
local function HealthRegenLogic()
    -- Regenerate health over time
    if LocalPlayer.Character and LocalPlayer.Character.Humanoid then
        LocalPlayer.Character.Humanoid.Health = LocalPlayer.Character.Humanoid.Health + 1
    end
end
local function AutoEatFruitLogic()
    -- Auto use fruits
end
local function GodModeLogic()
    -- Make invincible
    if LocalPlayer.Character and LocalPlayer.Character.Humanoid then
        LocalPlayer.Character.Humanoid.MaxHealth = math.huge
        LocalPlayer.Character.Humanoid.Health = math.huge
    end
end
local function InfiniteStaminaLogic()
    -- Infinite energy/stamina
end
local function AutoUseSkillsLogic()
    -- Auto activate skills on targets
end
local function KillAllLogic()
    for _, player in pairs(Services.Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character.Humanoid then
            player.Character.Humanoid.Health = 0
        end
    end
end
local function NoFallDamageLogic()
    -- Prevent fall damage
    game:GetService("Players").LocalPlayer.Character:FindFirstChild("Humanoid").FreeFalling:Connect(function()
        -- Set fall velocity to 0
    end)
end
-- [LAYER 4] UI IMPLEMENTATION
local Window = Fluent:CreateWindow({
    Title = "DinoPVP - BETA",
    SubTitle = "DinoDev",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.RightControl
})
local Tabs = {
    Aimbot = Window:AddTab({ Title = "Aimbot", Icon = "crosshair" }),
    Visuals = Window:AddTab({ Title = "Visuals (ESP)", Icon = "eye" }),
    Combat = Window:AddTab({ Title = "Combat", Icon = "swords" }),
    Movement = Window:AddTab({ Title = "Movement", Icon = "move" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "move" }),
    Legit = Window:AddTab({ Title = "Legit", Icon = "lock" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "box" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" }),
    PVPExtra = Window:AddTab({ Title = "PVP Extra", Icon = "swords" })
}
-- [[ AIMBOT TAB ]]
local AimbotSection = Tabs.Aimbot:AddSection("Aimbot Settings")
AimbotSection:AddToggle("EnableAimbot", {
    Title = "Enable Aimbot",
    Description = "Automatically aim at nearest enemy",
    Default = false,
    Callback = function(v) Config.EnableAimbot = v end
})
AimbotSection:AddDropdown("AimPart", {
    Title = "Aim Part",
    Values = {"Head", "HumanoidRootPart", "Torso"},
    Default = "Head",
    Callback = function(v) Config.AimPart = v end
})
AimbotSection:AddSlider("Smoothness", {
    Title = "Smoothness",
    Description = "Lower = stickier, higher = smoother",
    Min = 0, Max = 1, Default = 0.1, Rounding = 2,
    Callback = function(v) Config.Smoothness = v end
})
AimbotSection:AddToggle("RotateCharacter", {
    Title = "Rotate Character",
    Description = "Auto rotate character towards target",
    Default = true,
    Callback = function(v) Config.RotateCharacterToTarget = v end
})
AimbotSection:AddToggle("AimCursor", {
    Title = "Aim Cursor",
    Description = "Move mouse to target position",
    Default = false,
    Callback = function(v) Config.AimCursor = v end
})
local AdvancedAimbot = Tabs.Aimbot:AddSection("Advanced Settings")
AdvancedAimbot:AddToggle("WallCheck", {
    Title = "Wall Check",
    Default = true,
    Callback = function(v) Config.WallCheck = v end
})
AdvancedAimbot:AddToggle("TeamCheck", {
    Title = "Team Check",
    Default = true,
    Callback = function(v) Config.TeamCheck = v end
})
-- [[ VISUALS TAB ]]
local ESPSection = Tabs.Visuals:AddSection("ESP Settings")
ESPSection:AddToggle("EnableESP", {
    Title = "Enable ESP",
    Default = false,
    Callback = function(v) Config.EnableESP = v end
})
ESPSection:AddToggle("ShowBox", {
    Title = "Show Box",
    Default = false,
    Callback = function(v) Config.ShowBox = v end
})
ESPSection:AddToggle("ShowTracer", {
    Title = "Show Tracer",
    Default = false,
    Callback = function(v) Config.ShowTracer = v end
})
ESPSection:AddToggle("ShowName", {
    Title = "Show Name & Distance",
    Default = false,
    Callback = function(v) Config.ShowName = v end
})
ESPSection:AddToggle("ShowHealthBar", {
    Title = "Show Health Bar",
    Default = false,
    Callback = function(v) Config.ShowHealthBar = v end
})
local HighlightSection = Tabs.Visuals:AddSection("Highlight ESP")
HighlightSection:AddToggle("EnableHighlight", {
    Title = "Enable Highlight",
    Default = false,
    Callback = function(v) Config.EnableHighlight = v end
})
HighlightSection:AddColorpicker("HighlightFillColor", {
    Title = "Fill Color",
    Default = Color3.fromRGB(255, 0, 0),
    Callback = function(v) Config.HighlightFillColor = v end
})
HighlightSection:AddColorpicker("HighlightOutlineColor", {
    Title = "Outline Color",
    Default = Color3.fromRGB(255, 255, 255),
    Callback = function(v) Config.HighlightOutlineColor = v end
})
-- [[ COMBAT TAB ]]
local CombatSection = Tabs.Combat:AddSection("Combat Tools")
CombatSection:AddToggle("EnableKillAura", {
    Title = "Kill Aura",
    Description = "Auto attack enemies in range",
    Default = false,
    Callback = function(v) Config.EnableKillAura = v end
})
CombatSection:AddSlider("AuraRange", {
    Title = "Aura Range",
    Min = 5, Max = 50, Default = 20, Rounding = 0,
    Callback = function(v) Config.AuraRange = v end
})
CombatSection:AddToggle("TriggerBot", {
    Title = "TriggerBot",
    Description = "Auto fire when crosshair on enemy",
    Default = false,
    Callback = function(v) Config.TriggerBot = v end
})
local HitboxSection = Tabs.Combat:AddSection("Hitbox Expander")
HitboxSection:AddToggle("ExpandHitbox", {
    Title = "Enable Hitbox Expander",
    Default = false,
    Callback = function(v) Config.ExpandHitbox = v end
})
HitboxSection:AddSlider("HitboxSize", {
    Title = "Hitbox Size",
    Min = 2, Max = 30, Default = 10, Rounding = 0,
    Callback = function(v) Config.HitboxSize = v end
})
HitboxSection:AddSlider("Reach", {
    Title = "Reach",
    Min = 5, Max = 50, Default = 15, Rounding = 0,
    Callback = function(v) Config.Reach = v end
})
-- [[ MOVEMENT TAB ]]
local MovementSection = Tabs.Movement:AddSection("Character Mods")
MovementSection:AddToggle("Fly", {
    Title = "Fly",
    Default = false,
    Callback = function(v) Config.Fly = v end
})
MovementSection:AddSlider("FlySpeed", {
    Title = "Fly Speed",
    Min = 10, Max = 300, Default = 50, Rounding = 0,
    Callback = function(v) Config.FlySpeed = v end
})
MovementSection:AddToggle("Noclip", {
    Title = "Noclip",
    Default = false,
    Callback = function(v) Config.Noclip = v end
})
MovementSection:AddSlider("WalkSpeed", {
    Title = "Walk Speed",
    Min = 16, Max = 500, Default = 16, Rounding = 0,
    Callback = function(v) Config.WalkSpeed = v end
})
MovementSection:AddSlider("JumpPower", {
    Title = "Jump Power",
    Min = 50, Max = 500, Default = 50, Rounding = 0,
    Callback = function(v) Config.JumpPower = v end
})
MovementSection:AddToggle("InfiniteJump", {
    Title = "Infinite Jump",
    Default = false,
    Callback = function(v) Config.InfiniteJump = v end
})
-- [[ TELEPORT TAB ]]
local TeleportSection = Tabs.Teleport:AddSection("Teleport Settings")

TeleportSection:AddToggle("EnableTeleport", {
    Title = "Enable Teleport (Tween)",
    Default = false,
    Callback = function(v) 
        Config.EnableTeleport = v 
        if not v and _G.CurrentTeleportTween then
            _G.CurrentTeleportTween:Cancel()
        end
    end
})

local TargetDropdown = TeleportSection:AddDropdown("TeleportTarget", {
    Title = "Select Target Player",
    Values = {},
    Default = "",
    Callback = function(v) Config.TeleportTarget = v end
})

TeleportSection:AddToggle("TeleportLoop", {
    Title = "Loop Teleport (Stay on Target)",
    Default = false,
    Callback = function(v) Config.TeleportLoop = v end
})

TeleportSection:AddSlider("TeleportSpeed", {
    Title = "Tween Speed",
    Min = 50, Max = 800, Default = 150, Rounding = 0,
    Callback = function(v) Config.TeleportSpeed = v end
})

-- Hàm cập nhật danh sách người chơi cho Dropdown
local function UpdatePlayerList()
    local players = {}
    for _, player in ipairs(Services.Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(players, player.Name)
        end
    end
    TargetDropdown:SetValues(players)
end

-- Tự động cập nhật danh sách mỗi 5 giây
task.spawn(function()
    while task.wait(5) do
        UpdatePlayerList()
    end
end)
-- [[ LEGIT TAB ]]
local LegitSection = Tabs.Legit:AddSection("Legit Features")
LegitSection:AddToggle("EnableLegitAimbot", {
    Title = "Legit Aimbot",
    Default = false,
    Callback = function(v) Config.EnableLegitAimbot = v end
})
LegitSection:AddSlider("LegitSmoothness", {
    Title = "Legit Smoothness",
    Min = 0.3, Max = 1, Default = 0.5, Rounding = 2,
    Callback = function(v) Config.LegitSmoothness = v end
})
LegitSection:AddToggle("EnableLegitTween", {
    Title = "Legit Tween",
    Default = false,
    Callback = function(v) Config.EnableLegitTween = v end
})
LegitSection:AddSlider("LegitTweenSpeed", {
    Title = "Legit Tween Speed",
    Min = 20, Max = 100, Default = 50, Rounding = 0,
    Callback = function(v) Config.LegitTweenSpeed = v end
})
-- [[ PVP EXTRA TAB ]]
local PVPExtraSection = Tabs.PVPExtra:AddSection("Extra PVP Features")
PVPExtraSection:AddToggle("AutoParry", {
    Title = "Auto Parry",
    Default = false,
    Callback = function(v) Config.AutoParry = v end
})
PVPExtraSection:AddToggle("InfiniteCombo", {
    Title = "Infinite Combo",
    Default = false,
    Callback = function(v) Config.InfiniteCombo = v end
})
PVPExtraSection:AddToggle("NoStun", {
    Title = "No Stun",
    Default = false,
    Callback = function(v) Config.NoStun = v end
})
PVPExtraSection:AddToggle("AntiLock", {
    Title = "Anti Lock",
    Default = false,
    Callback = function(v) Config.AntiLock = v end
})
PVPExtraSection:AddToggle("AutoDodge", {
    Title = "Auto Dodge",
    Default = false,
    Callback = function(v) Config.AutoDodge = v end
})
PVPExtraSection:AddToggle("FastAttack", {
    Title = "Fast Attack",
    Default = false,
    Callback = function(v) Config.FastAttack = v end
})
PVPExtraSection:AddToggle("NoCooldown", {
    Title = "No Cooldown",
    Default = false,
    Callback = function(v) Config.NoCooldown = v end
})
PVPExtraSection:AddSlider("DamageMultiplier", {
    Title = "Damage Multiplier",
    Min = 1, Max = 10, Default = 1, Rounding = 0,
    Callback = function(v) Config.DamageMultiplier = v end
})
PVPExtraSection:AddToggle("HealthRegen", {
    Title = "Health Regen",
    Default = false,
    Callback = function(v) Config.HealthRegen = v end
})
PVPExtraSection:AddToggle("AutoEatFruit", {
    Title = "Auto Eat Fruit",
    Default = false,
    Callback = function(v) Config.AutoEatFruit = v end
})
PVPExtraSection:AddToggle("GodMode", {
    Title = "God Mode",
    Default = false,
    Callback = function(v) Config.GodMode = v end
})
PVPExtraSection:AddToggle("InfiniteStamina", {
    Title = "Infinite Stamina",
    Default = false,
    Callback = function(v) Config.InfiniteStamina = v end
})
PVPExtraSection:AddToggle("AutoUseSkills", {
    Title = "Auto Use Skills",
    Default = false,
    Callback = function(v) Config.AutoUseSkills = v end
})
PVPExtraSection:AddToggle("KillAll", {
    Title = "Kill All",
    Default = false,
    Callback = function(v) Config.KillAll = v end
})
PVPExtraSection:AddToggle("NoFallDamage", {
    Title = "No Fall Damage",
    Default = false,
    Callback = function(v) Config.NoFallDamage = v end
})
-- [[ MISC TAB ]]
local MiscSection = Tabs.Misc:AddSection("System Tools")
MiscSection:AddToggle("FPSBoost", {
    Title = "FPS Boost",
    Description = "Remove textures & effects",
    Default = false,
    Callback = function(v)
        Config.FPSBoost = v
        if v then
            for _, obj in pairs(game:GetDescendants()) do
                if obj:IsA("Texture") or obj:IsA("Decal") then
                    obj:Destroy()
                end
            end
            Services.Lighting.GlobalShadows = false
        end
    end
})
MiscSection:AddToggle("Fullbright", {
    Title = "Fullbright",
    Default = false,
    Callback = function(v)
        Config.Fullbright = v
        if v then
            Services.Lighting.Brightness = 2
            Services.Lighting.ClockTime = 14
            Services.Lighting.FogEnd = 100000
            Services.Lighting.GlobalShadows = false
        else
            Services.Lighting.Brightness = 1
            Services.Lighting.ClockTime = 12
            Services.Lighting.FogEnd = 1000
        end
    end
})
local SafetySection = Tabs.Misc:AddSection("Safety")
SafetySection:AddToggle("EnableSafety", {
    Title = "Auto Escape",
    Default = false,
    Callback = function(v) Config.EnableSafety = v end
})
SafetySection:AddSlider("SafetyHealth", {
    Title = "Escape Health %",
    Min = 10, Max = 50, Default = 30, Rounding = 0,
    Callback = function(v) Config.SafetyHealth = v end
})
-- [[ SETTINGS TAB ]]
local SecuritySection = Tabs.Settings:AddSection("Security & Management")
SecuritySection:AddToggle("AntiKick", {
    Title = "Anti-Kick",
    Description = "Block server-side kicks (client)",
    Default = false,
    Callback = function(v) Config.AntiKick = v end
})
SecuritySection:AddToggle("AntiAFK", {
    Title = "Anti-AFK",
    Default = true,
    Callback = function(v) Config.AntiAFK = v end
})
SecuritySection:AddButton({
    Title = "Destroy Script",
    Description = "Disable script, remove UI & clean up",
    Callback = function()
        Window:Destroy()
        for _, espData in pairs(ESPStorage) do
            for _, obj in pairs(espData) do
                if typeof(obj) == "Instance" then
                    obj:Destroy()
                else
                    obj:Remove()
                end
            end
        end
    end
})
-- [LAYER 4] EVENT HANDLING & MAIN LOOPS
local function AddESP(player: Player)
    if ESPStorage[player] then return end
   
    ESPStorage[player] = {
        Box = CreateDrawing("Square", {Thickness = 1.5, Color = Color3.fromRGB(255, 0, 0), Filled = false, Visible = false}),
        Tracer = CreateDrawing("Line", {Thickness = 1.5, Color = Color3.fromRGB(255, 0, 0), Visible = false}),
        Name = CreateDrawing("Text", {Size = 14, Center = true, Outline = true, Color = Color3.fromRGB(255, 255, 255), Visible = false}),
        HealthBarBorder = CreateDrawing("Square", {Thickness = 1, Color = Color3.new(0,0,0), Filled = false, Visible = false}),
        HealthBarFill = CreateDrawing("Square", {Thickness = 1, Filled = true, Visible = false}),
        Highlight = nil
    }
end
local function RemoveESP(player: Player)
    if ESPStorage[player] then
        for _, obj in pairs(ESPStorage[player]) do
            if typeof(obj) == "Instance" and obj then
                obj:Destroy()
            elseif obj then
                obj:Remove()
            end
        end
        ESPStorage[player] = nil
    end
end
local function UpdateESP()
    for player, esp in pairs(ESPStorage) do
        if Config.EnableESP and IsValidTarget(player) then
            local char = player.Character
            local root = char:FindFirstChild("HumanoidRootPart")
            local humanoid = char:FindFirstChild("Humanoid")
            local head = char:FindFirstChild("Head")
           
            if root and humanoid and head then
                local topPos = head.Position + Vector3.new(0, 1, 0)
                local bottomPos = root.Position - Vector3.new(0, 3, 0)
               
                local top, onScreenTop = CurrentCamera:WorldToViewportPoint(topPos)
                local bottom, onScreenBottom = CurrentCamera:WorldToViewportPoint(bottomPos)
               
                if onScreenTop and onScreenBottom then
                    local height = math.abs(top.Y - bottom.Y)
                    local width = height / 2
                    local posY = math.min(top.Y, bottom.Y)
                    local posX = (top.X + bottom.X) / 2 - width / 2
                    local topLeft = Vector2.new(posX, posY)
                    local size = Vector2.new(width, height)
                    local centerX = posX + width / 2
                    local bottomY = posY + height
                   
                    -- Box
                    if Config.ShowBox then
                        esp.Box.Visible = true
                        esp.Box.Position = topLeft
                        esp.Box.Size = size
                    else
                        esp.Box.Visible = false
                    end
                   
                    -- Tracer
                    if Config.ShowTracer then
                        esp.Tracer.Visible = true
                        esp.Tracer.From = Vector2.new(CurrentCamera.ViewportSize.X / 2, CurrentCamera.ViewportSize.Y)
                        esp.Tracer.To = Vector2.new(centerX, bottomY)
                    else
                        esp.Tracer.Visible = false
                    end
                   
                    -- Name
                    if Config.ShowName then
                        esp.Name.Visible = true
                        esp.Name.Position = Vector2.new(centerX, posY - 15)
                        esp.Name.Text = string.format("%s [%.0fm]", player.Name, (root.Position - CurrentCamera.CFrame.Position).Magnitude)
                    else
                        esp.Name.Visible = false
                    end
                   
                    -- Health Bar
                    if Config.ShowHealthBar then
                        esp.HealthBarBorder.Visible = true
                        esp.HealthBarFill.Visible = true
                       
                        local barWidth = 2
                        local offset = 4
                        local healthPct = humanoid.Health / humanoid.MaxHealth
                        local barHeight = height * healthPct
                       
                        esp.HealthBarBorder.Position = Vector2.new(posX - offset - barWidth, posY)
                        esp.HealthBarBorder.Size = Vector2.new(barWidth, height)
                       
                        esp.HealthBarFill.Position = Vector2.new(posX - offset - barWidth, posY + (height - barHeight))
                        esp.HealthBarFill.Size = Vector2.new(barWidth, barHeight)
                        esp.HealthBarFill.Color = Color3.fromHSV(healthPct * 0.3, 1, 1)
                    else
                        esp.HealthBarBorder.Visible = false
                        esp.HealthBarFill.Visible = false
                    end
                else
                    for k, obj in pairs(esp) do
                        if k ~= "Highlight" then obj.Visible = false end
                    end
                end
               
                -- Highlight
                if Config.EnableHighlight then
                    if not esp.Highlight then
                        esp.Highlight = Instance.new("Highlight")
                        esp.Highlight.Adornee = char
                        esp.Highlight.Parent = char
                    end
                    esp.Highlight.FillColor = Config.HighlightFillColor
                    esp.Highlight.FillTransparency = Config.HighlightFillTransparency
                    esp.Highlight.OutlineColor = Config.HighlightOutlineColor
                    esp.Highlight.OutlineTransparency = Config.HighlightOutlineTransparency
                elseif esp.Highlight then
                    esp.Highlight:Destroy()
                    esp.Highlight = nil
                end
            else
                for k, obj in pairs(esp) do
                    if k == "Highlight" and obj then
                        obj:Destroy()
                    elseif k ~= "Highlight" then
                        obj.Visible = false
                    end
                end
                esp.Highlight = nil
            end
        else
            for k, obj in pairs(esp) do
                if k == "Highlight" and obj then
                    obj:Destroy()
                elseif k ~= "Highlight" then
                    obj.Visible = false
                end
            end
            esp.Highlight = nil
        end
    end
end
-- Dynamic player list for teleport
local function UpdatePlayerList()
    local players = {}
    for _, player in ipairs(Services.Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(players, player.Name)
        end
    end
    Tabs.Teleport.Elements.TeleportTarget.Values = players
    Tabs.Teleport.Elements.TeleportTarget:BuildDropdownList()
end
task.spawn(function()
    while true do
        UpdatePlayerList()
        task.wait(5)
    end
end)
Services.RunService.RenderStepped:Connect(function()
    UpdateESP()
   
    if Config.EnableAimbot or Config.EnableLegitAimbot then
        local smoothness = Config.EnableLegitAimbot and Config.LegitSmoothness or Config.Smoothness
        local target = GetNearestPlayer()
        if target and target.Character and target.Character:FindFirstChild(Config.AimPart) then
            local targetPos = target.Character[Config.AimPart].Position
            local currentCFrame = CurrentCamera.CFrame
            local targetCFrame = CFrame.new(currentCFrame.Position, targetPos)
           
            if smoothness <= 0.05 then
                CurrentCamera.CFrame = targetCFrame
            else
                CurrentCamera.CFrame = currentCFrame:Lerp(targetCFrame, 1 - smoothness)
            end
           
            if Config.RotateCharacterToTarget and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local root = LocalPlayer.Character.HumanoidRootPart
                local lookDir = Vector3.new(targetPos.X, root.Position.Y, targetPos.Z)
                root.CFrame = CFrame.new(root.Position, lookDir)
            end
           
            if Config.AimCursor then
                local screenPos = CurrentCamera:WorldToScreenPoint(targetPos)
                local mousePos = Services.UserInputService:GetMouseLocation()
                local delta = Vector2.new(screenPos.X - mousePos.X, screenPos.Y - mousePos.Y)
                Services.VirtualInputManager:SendMouseMoveEvent(delta.X, delta.Y, game)
            end
           
            if Config.TriggerBot then
                local targetUnderMouse = Mouse.Target
                if targetUnderMouse and targetUnderMouse:IsDescendantOf(target.Character) then
                    Fire()
                end
            end
        end
    end
end)
Services.RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    -- Logic Teleport/Tween
    if Config.EnableTeleport and Config.TeleportTarget ~= "" then
        local targetPlayer = Services.Players:FindFirstChild(Config.TeleportTarget)
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = targetPlayer.Character.HumanoidRootPart.Position
            
            -- Nếu Loop được bật hoặc chưa bắt đầu Tween
            if Config.TeleportLoop then
                -- Bám sát mục tiêu (Dịch chuyển tức thời hoặc Tween ngắn)
                char.HumanoidRootPart.CFrame = targetPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 3)
            else
                -- Tween tới mục tiêu một lần
                if not _G.TeleportingNow then
                    _G.TeleportingNow = true
                    local tween = TweenToPosition(targetPos, Config.TeleportSpeed)
                    if tween then
                        tween.Completed:Wait()
                    end
                    Config.EnableTeleport = false -- Tự tắt sau khi tới nơi
                    _G.TeleportingNow = false
                end
            end
        end
    end
   
    local root = char.HumanoidRootPart
    local humanoid = char:FindFirstChild("Humanoid")
   
    -- Hitbox Expander & Reach
    if Config.ExpandHitbox then
        for _, player in pairs(Services.Players:GetPlayers()) do
            if IsValidTarget(player) then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    targetRoot.Size = Vector3.new(Config.HitboxSize, Config.HitboxSize, Config.HitboxSize)
                    targetRoot.Transparency = Config.HitboxTransparency
                    targetRoot.CanCollide = false
                end
            end
        end
    else
        for _, player in pairs(Services.Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local targetRoot = player.Character.HumanoidRootPart
                if targetRoot.Size.X == Config.HitboxSize then
                    targetRoot.Size = Vector3.new(2, 2, 1)
                    targetRoot.Transparency = 1
                end
            end
        end
    end
   
    -- Kill Aura with Reach
    if Config.EnableKillAura then
        for _, player in pairs(Services.Players:GetPlayers()) do
            if IsValidTarget(player) then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot and (root.Position - targetRoot.Position).Magnitude <= Config.Reach then
                    root.CFrame = CFrame.new(root.Position, Vector3.new(targetRoot.Position.X, root.Position.Y, targetRoot.Position.Z))
                    Fire()
                end
            end
        end
    end
   
    -- Fly
    if Config.Fly then
        local velocity = root:FindFirstChild("DinoFlyVelocity") or Instance.new("BodyVelocity")
        velocity.Name = "DinoFlyVelocity"
        velocity.Parent = root
        velocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
       
        local camCFrame = CurrentCamera.CFrame
        local velocityVector = Vector3.new()
       
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.W) then velocityVector = velocityVector + camCFrame.LookVector end
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.S) then velocityVector = velocityVector - camCFrame.LookVector end
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.A) then velocityVector = velocityVector - camCFrame.RightVector end
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.D) then velocityVector = velocityVector + camCFrame.RightVector end
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.Space) then velocityVector = velocityVector + Vector3.new(0, 1, 0) end
        if Services.UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then velocityVector = velocityVector - Vector3.new(0, 1, 0) end
       
        velocity.Velocity = velocityVector * Config.FlySpeed
    else
        local velocity = root:FindFirstChild("DinoFlyVelocity")
        if velocity then velocity:Destroy() end
    end
   
    -- Noclip
    if Config.Noclip then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then
                part.CanCollide = false
            end
        end
    end
   
    -- WalkSpeed & JumpPower
    if humanoid then
        if Config.WalkSpeed > 16 then humanoid.WalkSpeed = Config.WalkSpeed end
        if Config.JumpPower > 50 then humanoid.JumpPower = Config.JumpPower end
    end
   
    -- Safety
    if Config.EnableSafety and humanoid and humanoid.Health / humanoid.MaxHealth * 100 < Config.SafetyHealth then
        local escapePos = root.Position + Vector3.new(math.random(-Config.EscapeDistance, Config.EscapeDistance), 0, math.random(-Config.EscapeDistance, Config.EscapeDistance))
        TweenToPosition(escapePos, Config.TeleportSpeed)
    end
   
    -- Teleport & Legit Tween
    local tweenSpeed = Config.EnableLegitTween and Config.LegitTweenSpeed or Config.TeleportSpeed
    if (Config.EnableTeleport or Config.EnableLegitTween) and Config.TeleportTarget ~= "" then
        local targetPlayer = Services.Players:FindFirstChild(Config.TeleportTarget)
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = targetPlayer.Character.HumanoidRootPart.Position
            TweenToPosition(targetPos, tweenSpeed)
            if Config.TeleportLoop or Config.EnableLegitTween then
                task.wait(0.1) -- Small delay to loop smoothly
            end
        end
    end
   
    -- New PVP Functions
    if Config.AutoParry then AutoParryLogic() end
    if Config.InfiniteCombo then InfiniteComboLogic() end
    if Config.NoStun then NoStunLogic() end
    if Config.AntiLock then AntiLockLogic() end
    if Config.AutoDodge then AutoDodgeLogic() end
    if Config.FastAttack then FastAttackLogic() end
    if Config.NoCooldown then NoCooldownLogic() end
    if Config.HealthRegen then HealthRegenLogic() end
    if Config.AutoEatFruit then AutoEatFruitLogic() end
    if Config.GodMode then GodModeLogic() end
    if Config.InfiniteStamina then InfiniteStaminaLogic() end
    if Config.AutoUseSkills then AutoUseSkillsLogic() end
    if Config.KillAll then KillAllLogic() end
    if Config.NoFallDamage then NoFallDamageLogic() end
end)
Services.Players.PlayerAdded:Connect(function(player)
    AddESP(player)
    player.CharacterAdded:Connect(function() AddESP(player) end)
end)
Services.Players.PlayerRemoving:Connect(RemoveESP)
for _, player in pairs(Services.Players:GetPlayers()) do
    if player ~= LocalPlayer then
        AddESP(player)
        player.CharacterAdded:Connect(function() AddESP(player) end)
    end
end
Services.UserInputService.JumpRequest:Connect(function()
    if Config.InfiniteJump and LocalPlayer.Character then
        local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid:ChangeState("Jumping")
        end
    end
end)
task.spawn(function()
    local success, err = pcall(function()
        local oldNamecall
        if getnamecallmethod and hookmetamethod then
            oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
                local method = getnamecallmethod()
                if Config.AntiKick and self == LocalPlayer and (method == "Kick" or method == "kick") then
                    return nil
                end
                return oldNamecall(self, ...)
            end)
        end
    end)
    if not success then
        warn("Failed to enable Anti-Kick: " .. tostring(err))
    end
end)
LocalPlayer.Idled:Connect(function()
    if Config.AntiAFK then
        local vu = game:GetService("VirtualUser")
        vu:CaptureController()
        vu:ClickButton2(Vector2.new())
    end
end)
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetFolder("DinoPVP_V4_Config")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1)
Fluent:Notify({
    Title = "DinoDEV",
    Content = "Chúc Bạn Chơi Game Vui Vẻ.",
    Duration = 8
})
