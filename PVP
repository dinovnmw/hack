--[[
    DinoPVP V4 - ULTIMATE BATTLE-HARDENED EDITION
    Architecture: Advanced Metatable Hooking, Drawing API, CFrame Manipulation
    Security: Anti-Detection, Environment Spoofing, Silent Aim, Velocity Bypass
    
    [INTERNAL BATTLE LOG]
    > AUDIT: Detected weak WalkSpeed logic. REPLACED with CFrame/Velocity manipulation.
    > AUDIT: Detected detectable Highlight ESP. REPLACED with Drawing API (Synapse/Krnl/Fluxus compatible).
    > AUDIT: Detected basic Anti-Kick. UPGRADED to Metatable Hooking for __namecall and __index.
    > ADDED: Silent Aim, FOV Circle, Tracers, Server Hop, Rejoin, Anti-Stun.
]]

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- ================= SERVICES =================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Stats = game:GetService("Stats")

-- ================= VARIABLES =================
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- ================= DRAWING API SETUP =================
local DrawingLib = {
    FOVCircle = Drawing.new("Circle"),
    ESP = {}
}

DrawingLib.FOVCircle.Visible = false
DrawingLib.FOVCircle.Thickness = 1.5
DrawingLib.FOVCircle.Color = Color3.fromRGB(255, 255, 255)
DrawingLib.FOVCircle.Filled = false
DrawingLib.FOVCircle.Transparency = 1
DrawingLib.FOVCircle.NumSides = 64

-- ================= CONFIGURATION =================
local Options = Fluent.Options
local Config = {
    -- Aimbot
    Aimbot = false,
    SilentAim = false,
    AimMode = "Nearest Character",
    AimPart = "Head",
    AimSmooth = 0.1,
    RotateCharacter = true,
    FOVSize = 150,
    ShowFOV = false,
    
    -- Combat
    KillAura = false,
    KillAuraRange = 20,
    TriggerBot = false,
    Hitbox = false,
    HitboxSize = 10,
    Spinbot = false,
    SpinSpeed = 50,
    Dodge = false,
    DodgeSpeed = 5,
    DodgePower = 2,
    
    -- Visuals (Drawing API)
    ESP = false,
    ESPBox = false,
    ESPTracer = false,
    ESPName = false,
    ESPHealth = false,
    ESPTeamCheck = true,
    
    -- Movement
    SpeedHack = false,
    SpeedVal = 16, -- CFrame Speed
    Fly = false,
    FlySpeed = 50,
    Noclip = false,
    InfJump = false,
    
    -- Security & Misc
    AntiKick = true,
    AntiAFK = true,
    AntiStun = false,
    SpoofWalkSpeed = true
}

-- ================= UI SETUP =================
local Window = Fluent:CreateWindow({
    Title = "DinoPVP V4 [ULTIMATE]",
    SubTitle = "Battle-Hardened",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Aimbot = Window:AddTab({ Title = "Aimbot", Icon = "crosshair" }),
    Combat = Window:AddTab({ Title = "Combat", Icon = "swords" }),
    Visuals = Window:AddTab({ Title = "Visuals", Icon = "eye" }),
    Movement = Window:AddTab({ Title = "Movement", Icon = "move" }),
    Security = Window:AddTab({ Title = "Security", Icon = "shield" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "box" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- ================= HELPER FUNCTIONS =================
local function IsValidEnemy(plr)
    if not plr or plr == LocalPlayer or not plr.Character then return false end
    local hum = plr.Character:FindFirstChild("Humanoid")
    local root = plr.Character:FindFirstChild("HumanoidRootPart")
    
    if not hum or not root or hum.Health <= 0 then return false end
    
    if Config.ESPTeamCheck and plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team then
        return false
    end
    
    if plr.Character:FindFirstChild("ForceField") then return false end
    
    return true
end

local function GetClosestPlayerToCursor()
    local closestPlr = nil
    local shortestDist = Config.FOVSize
    
    for _, v in pairs(Players:GetPlayers()) do
        if IsValidEnemy(v) then
            local root = v.Character:FindFirstChild(Config.AimPart) or v.Character:FindFirstChild("Head")
            if root then
                local pos, onScreen = Camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local dist = (Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y) - Vector2.new(pos.X, pos.Y)).Magnitude
                    if dist < shortestDist then
                        closestPlr = v
                        shortestDist = dist
                    end
                end
            end
        end
    end
    return closestPlr
end

local function AttackClick()
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
    task.wait(0.01)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
end

-- ================= UI ELEMENTS =================

-- [[ AIMBOT TAB ]]
local AimGroup = Tabs.Aimbot:AddSection("Targeting")
AimGroup:AddToggle("AimbotToggle", {Title = "Enable Camera Aimbot", Default = false, Callback = function(v) Config.Aimbot = v end})
AimGroup:AddToggle("SilentAimToggle", {Title = "Silent Aim (Hook)", Description = "Shoots target without moving camera", Default = false, Callback = function(v) Config.SilentAim = v end})
AimGroup:AddDropdown("AimPart", {Title = "Aim Part", Values = {"Head", "HumanoidRootPart", "Torso"}, Default = "Head", Callback = function(v) Config.AimPart = v end})
AimGroup:AddToggle("RotateChar", {Title = "Rotate Character", Default = true, Callback = function(v) Config.RotateCharacter = v end})
AimGroup:AddSlider("AimSmooth", {Title = "Smoothness", Min = 0, Max = 1, Default = 0.1, Rounding = 2, Callback = function(v) Config.AimSmooth = v end})

local FOVGroup = Tabs.Aimbot:AddSection("FOV Settings")
FOVGroup:AddToggle("ShowFOV", {Title = "Draw FOV Circle", Default = false, Callback = function(v) Config.ShowFOV = v end})
FOVGroup:AddSlider("FOVSize", {Title = "FOV Radius", Min = 10, Max = 800, Default = 150, Rounding = 0, Callback = function(v) Config.FOVSize = v end})

-- [[ COMBAT TAB ]]
local CombatGroup = Tabs.Combat:AddSection("PVP")
CombatGroup:AddToggle("KillAura", {Title = "Kill Aura", Default = false, Callback = function(v) Config.KillAura = v end})
CombatGroup:AddSlider("AuraRange", {Title = "Range", Min = 5, Max = 50, Default = 20, Rounding = 0, Callback = function(v) Config.KillAuraRange = v end})
CombatGroup:AddToggle("TriggerBot", {Title = "TriggerBot", Default = false, Callback = function(v) Config.TriggerBot = v end})
CombatGroup:AddToggle("Hitbox", {Title = "Hitbox Expander", Default = false, Callback = function(v) Config.Hitbox = v end})
CombatGroup:AddSlider("HitboxSize", {Title = "Hitbox Size", Min = 2, Max = 30, Default = 10, Rounding = 0, Callback = function(v) Config.HitboxSize = v end})

local AntiAimGroup = Tabs.Combat:AddSection("Anti-Aim")
AntiAimGroup:AddToggle("Spinbot", {Title = "Spinbot", Default = false, Callback = function(v) Config.Spinbot = v end})
AntiAimGroup:AddSlider("SpinSpeed", {Title = "Spin Speed", Min = 10, Max = 100, Default = 50, Rounding = 0, Callback = function(v) Config.SpinSpeed = v end})
AntiAimGroup:AddToggle("Dodge", {Title = "Auto Dodge", Default = false, Callback = function(v) Config.Dodge = v end})

-- [[ VISUALS TAB ]]
local VisualsGroup = Tabs.Visuals:AddSection("Drawing ESP")
VisualsGroup:AddToggle("ESP", {Title = "Master Switch", Default = false, Callback = function(v) Config.ESP = v end})
VisualsGroup:AddToggle("ESPBox", {Title = "Boxes", Default = false, Callback = function(v) Config.ESPBox = v end})
VisualsGroup:AddToggle("ESPTracer", {Title = "Tracers", Default = false, Callback = function(v) Config.ESPTracer = v end})
VisualsGroup:AddToggle("ESPName", {Title = "Names", Default = false, Callback = function(v) Config.ESPName = v end})
VisualsGroup:AddToggle("ESPHealth", {Title = "Health Bar", Default = false, Callback = function(v) Config.ESPHealth = v end})
VisualsGroup:AddToggle("ESPTeam", {Title = "Team Check", Default = true, Callback = function(v) Config.ESPTeamCheck = v end})

-- [[ MOVEMENT TAB ]]
local MoveGroup = Tabs.Movement:AddSection("Locomotion")
MoveGroup:AddToggle("SpeedHack", {Title = "CFrame Speed (Bypass)", Description = "Bypasses WalkSpeed checks", Default = false, Callback = function(v) Config.SpeedHack = v end})
MoveGroup:AddSlider("SpeedVal", {Title = "Speed Factor", Min = 16, Max = 200, Default = 16, Rounding = 0, Callback = function(v) Config.SpeedVal = v end})
MoveGroup:AddToggle("Fly", {Title = "Fly", Default = false, Callback = function(v) Config.Fly = v end})
MoveGroup:AddSlider("FlySpeed", {Title = "Fly Speed", Min = 10, Max = 200, Default = 50, Rounding = 0, Callback = function(v) Config.FlySpeed = v end})
MoveGroup:AddToggle("Noclip", {Title = "Noclip", Default = false, Callback = function(v) Config.Noclip = v end})
MoveGroup:AddToggle("InfJump", {Title = "Infinite Jump", Default = false, Callback = function(v) Config.InfJump = v end})

-- [[ SECURITY TAB ]]
local SecurityGroup = Tabs.Security:AddSection("Hardening")
SecurityGroup:AddToggle("AntiKick", {Title = "Anti-Kick (Metatable)", Default = true, Callback = function(v) Config.AntiKick = v end})
SecurityGroup:AddToggle("SpoofWS", {Title = "Spoof WalkSpeed", Description = "Server sees 16 WS", Default = true, Callback = function(v) Config.SpoofWalkSpeed = v end})
SecurityGroup:AddToggle("AntiStun", {Title = "Anti-Stun", Default = false, Callback = function(v) Config.AntiStun = v end})
SecurityGroup:AddButton({
    Title = "Force Garbage Collection",
    Description = "Clear memory traces",
    Callback = function() 
        for i=1, 5 do collectgarbage() end
        Fluent:Notify({Title = "System", Content = "Memory Cleaned", Duration = 2})
    end
})

-- [[ MISC TAB ]]
local MiscGroup = Tabs.Misc:AddSection("Utilities")
MiscGroup:AddButton({
    Title = "Server Hop",
    Callback = function()
        local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
        for _, v in pairs(servers.data) do
            if v.playing < v.maxPlayers then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, v.id, LocalPlayer)
                break
            end
        end
    end
})
MiscGroup:AddButton({
    Title = "Rejoin Server",
    Callback = function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
    end
})

-- ================= CORE LOGIC & HOOKS =================

-- [1] METATABLE HOOKS (The "Super Antiban" & Silent Aim)
local mt = getrawmetatable(game)
local oldNameCall = mt.__namecall
local oldIndex = mt.__index
local oldNewIndex = mt.__newindex
setreadonly(mt, false)

-- Silent Aim & Anti-Kick Hook
mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()

    -- Anti-Kick
    if Config.AntiKick and (method == "Kick" or method == "kick") and self == LocalPlayer then
        return nil
    end

    -- Silent Aim
    if Config.SilentAim and (method == "Raycast" or method == "FindPartOnRay" or method == "FindPartOnRayWithIgnoreList") then
        local target = GetClosestPlayerToCursor()
        if target and target.Character and target.Character:FindFirstChild(Config.AimPart) then
            local origin = args[1]
            local dest = target.Character[Config.AimPart].Position
            local direction = (dest - origin).Unit * 1000
            
            if method == "Raycast" then
                args[2] = direction
            else
                -- For older raycast methods
                args[2] = direction
            end
            return oldNameCall(self, unpack(args))
        end
    end

    return oldNameCall(self, ...)
end)

-- WalkSpeed Spoofing (Anti-Detect)
mt.__index = newcclosure(function(self, key)
    if Config.SpoofWalkSpeed and not checkcaller() then
        if key == "WalkSpeed" and self:IsA("Humanoid") then
            return 16
        elseif key == "JumpPower" and self:IsA("Humanoid") then
            return 50
        end
    end
    return oldIndex(self, key)
end)

setreadonly(mt, true)

-- [2] RENDER LOOP (Aimbot, FOV, Visuals)
RunService.RenderStepped:Connect(function()
    -- FOV Circle Update
    DrawingLib.FOVCircle.Visible = Config.ShowFOV
    DrawingLib.FOVCircle.Radius = Config.FOVSize
    DrawingLib.FOVCircle.Position = UserInputService:GetMouseLocation()

    -- Camera Aimbot
    if Config.Aimbot then
        local target = GetClosestPlayerToCursor()
        if target and target.Character and target.Character:FindFirstChild(Config.AimPart) then
            local targetPos = target.Character[Config.AimPart].Position
            local currentCF = Camera.CFrame
            local goalCF = CFrame.new(currentCF.Position, targetPos)
            
            Camera.CFrame = currentCF:Lerp(goalCF, 1 - Config.AimSmooth)
            
            if Config.RotateCharacter and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = LocalPlayer.Character.HumanoidRootPart
                local lookAt = Vector3.new(targetPos.X, hrp.Position.Y, targetPos.Z)
                hrp.CFrame = CFrame.new(hrp.Position, lookAt)
            end
            
            if Config.TriggerBot then
                local mouseTarget = Mouse.Target
                if mouseTarget and mouseTarget:IsDescendantOf(target.Character) then
                    AttackClick()
                end
            end
        end
    end
end)

-- [3] PHYSICS LOOP (Movement, Combat)
RunService.Heartbeat:Connect(function(dt)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local hrp = char.HumanoidRootPart
    local hum = char:FindFirstChild("Humanoid")

    -- CFrame Speed (Bypass)
    if Config.SpeedHack and hum.MoveDirection.Magnitude > 0 then
        hrp.CFrame = hrp.CFrame + (hum.MoveDirection * (Config.SpeedVal - 16) * dt)
    end

    -- Kill Aura
    if Config.KillAura then
        for _, v in pairs(Players:GetPlayers()) do
            if IsValidEnemy(v) then
                local enemyRoot = v.Character:FindFirstChild("HumanoidRootPart")
                if enemyRoot and (hrp.Position - enemyRoot.Position).Magnitude <= Config.KillAuraRange then
                    -- Face enemy for valid hit
                    hrp.CFrame = CFrame.new(hrp.Position, Vector3.new(enemyRoot.Position.X, hrp.Position.Y, enemyRoot.Position.Z))
                    AttackClick()
                end
            end
        end
    end

    -- Hitbox Expander
    if Config.Hitbox then
        for _, v in pairs(Players:GetPlayers()) do
            if IsValidEnemy(v) then
                local eHrp = v.Character:FindFirstChild("HumanoidRootPart")
                if eHrp then
                    eHrp.Size = Vector3.new(Config.HitboxSize, Config.HitboxSize, Config.HitboxSize)
                    eHrp.Transparency = 0.7
                    eHrp.CanCollide = false
                end
            end
        end
    end

    -- Spinbot
    if Config.Spinbot then
        hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(Config.SpinSpeed), 0)
    end

    -- Dodge
    if Config.Dodge then
        local strafe = math.sin(tick() * Config.DodgeSpeed) * Config.DodgePower
        hrp.CFrame = hrp.CFrame * CFrame.new(strafe, 0, 0)
    end

    -- Fly
    if Config.Fly then
        local bv = hrp:FindFirstChild("DinoFly") or Instance.new("BodyVelocity")
        bv.Name = "DinoFly"
        bv.Parent = hrp
        bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
        
        local camCF = Camera.CFrame
        local vel = Vector3.new()
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then vel = vel + camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then vel = vel - camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then vel = vel - camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then vel = vel + camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then vel = vel + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then vel = vel - Vector3.new(0, 1, 0) end
        
        bv.Velocity = vel * Config.FlySpeed
    else
        local bv = hrp:FindFirstChild("DinoFly")
        if bv then bv:Destroy() end
    end

    -- Noclip
    if Config.Noclip then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then part.CanCollide = false end
        end
    end
    
    -- Anti-Stun
    if Config.AntiStun and hum then
        hum.PlatformStand = false
        hum.Sit = false
    end
end)

-- [4] ESP MANAGER (Drawing API)
local function CreateESP(plr)
    local Box = Drawing.new("Square")
    Box.Visible = false
    Box.Color = Color3.fromRGB(255, 0, 0)
    Box.Thickness = 1
    Box.Transparency = 1
    Box.Filled = false

    local Tracer = Drawing.new("Line")
    Tracer.Visible = false
    Tracer.Color = Color3.fromRGB(255, 0, 0)
    Tracer.Thickness = 1
    Tracer.Transparency = 1

    local Name = Drawing.new("Text")
    Name.Visible = false
    Name.Color = Color3.fromRGB(255, 255, 255)
    Name.Size = 16
    Name.Center = true
    Name.Outline = true

    local HealthBar = Drawing.new("Square")
    HealthBar.Visible = false
    HealthBar.Color = Color3.fromRGB(0, 255, 0)
    HealthBar.Thickness = 1
    HealthBar.Filled = true

    local function Update()
        local c = RunService.RenderStepped:Connect(function()
            if Config.ESP and IsValidEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") then
                local hrp = plr.Character.HumanoidRootPart
                local hum = plr.Character.Humanoid
                local vec, onScreen = Camera:WorldToViewportPoint(hrp.Position)

                if onScreen then
                    -- Box
                    if Config.ESPBox then
                        Box.Visible = true
                        local size = Vector2.new(2000 / vec.Z, 2500 / vec.Z)
                        Box.Size = size
                        Box.Position = Vector2.new(vec.X - size.X / 2, vec.Y - size.Y / 2)
                    else
                        Box.Visible = false
                    end

                    -- Tracer
                    if Config.ESPTracer then
                        Tracer.Visible = true
                        Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                        Tracer.To = Vector2.new(vec.X, vec.Y)
                    else
                        Tracer.Visible = false
                    end

                    -- Name
                    if Config.ESPName then
                        Name.Visible = true
                        Name.Text = plr.Name .. " [" .. math.floor((LocalPlayer.Character.HumanoidRootPart.Position - hrp.Position).Magnitude) .. "m]"
                        Name.Position = Vector2.new(vec.X, vec.Y - (Box.Size.Y / 2) - 20)
                    else
                        Name.Visible = false
                    end

                    -- Health
                    if Config.ESPHealth then
                        HealthBar.Visible = true
                        local healthPct = hum.Health / hum.MaxHealth
                        HealthBar.Size = Vector2.new(2, Box.Size.Y * healthPct)
                        HealthBar.Position = Vector2.new(Box.Position.X - 6, Box.Position.Y + (Box.Size.Y * (1 - healthPct)))
                        HealthBar.Color = Color3.fromHSV(healthPct * 0.3, 1, 1)
                    else
                        HealthBar.Visible = false
                    end
                else
                    Box.Visible = false
                    Tracer.Visible = false
                    Name.Visible = false
                    HealthBar.Visible = false
                end
            else
                Box.Visible = false
                Tracer.Visible = false
                Name.Visible = false
                HealthBar.Visible = false
            end
        end)
        
        -- Cleanup on player leaving
        plr.AncestryChanged:Connect(function(_, parent)
            if not parent then
                c:Disconnect()
                Box:Remove()
                Tracer:Remove()
                Name:Remove()
                HealthBar:Remove()
            end
        end)
    end
    coroutine.wrap(Update)()
end

for _, v in pairs(Players:GetPlayers()) do
    if v ~= LocalPlayer then CreateESP(v) end
end
Players.PlayerAdded:Connect(function(v)
    CreateESP(v)
end)

-- [5] INF JUMP
UserInputService.JumpRequest:Connect(function()
    if Config.InfJump and LocalPlayer.Character then
        local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
        if hum then hum:ChangeState("Jumping") end
    end
end)

-- ================= FINALIZE =================
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetFolder("DinoPVP_V4")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "DinoPVP V4 Loaded",
    Content = "Battle-Hardened Edition Active.\nAnti-Kick & Silent Aim Hooked.",
    Duration = 5
})
